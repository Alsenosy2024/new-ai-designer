<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªÙ‚ÙŠÙŠÙ… Ù†Ø¸Ø§Ù… AI Architect Designer</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-700: #374151;
            --gray-800: #1f2937;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #60a5fa, #34d399);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            color: #94a3b8;
            font-size: 1.1rem;
        }

        .status-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            font-size: 14px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ef4444;
        }

        .status-dot.online { background: #10b981; }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 24px;
            backdrop-filter: blur(10px);
        }

        .card h3 {
            font-size: 1.2rem;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #94a3b8;
            font-size: 14px;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
            color: white;
            font-size: 14px;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .agents-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }

        .agent-card {
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            text-align: center;
        }

        .agent-icon { font-size: 24px; }
        .agent-name { font-size: 12px; color: #94a3b8; margin-top: 4px; }
        .agent-status { font-size: 10px; margin-top: 4px; }
        .agent-status.pending { color: #94a3b8; }
        .agent-status.running { color: var(--warning); }
        .agent-status.done { color: var(--success); }

        .progress-container {
            margin: 20px 0;
        }

        .progress-bar {
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--success));
            width: 0%;
            transition: width 0.3s;
        }

        .progress-text {
            text-align: center;
            margin-top: 8px;
            font-size: 14px;
            color: #94a3b8;
        }

        .results-panel {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .results-panel.active { display: block; }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .result-item {
            text-align: center;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }

        .result-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--success);
        }

        .result-label {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 4px;
        }

        .output-section {
            background: rgba(0,0,0,0.4);
            border-radius: 8px;
            padding: 16px;
            max-height: 300px;
            overflow-y: auto;
        }

        .output-item {
            padding: 8px 12px;
            margin-bottom: 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            border-right: 3px solid var(--primary);
        }

        .output-item.architecture { border-color: #3b82f6; }
        .output-item.structural { border-color: #ef4444; }
        .output-item.mep { border-color: #10b981; }
        .output-item.interior { border-color: #f59e0b; }

        .log-section {
            font-family: monospace;
            font-size: 12px;
            background: #0f172a;
            padding: 16px;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .log-entry {
            padding: 4px 0;
            color: #94a3b8;
        }

        .log-entry.success { color: var(--success); }
        .log-entry.error { color: var(--danger); }
        .log-entry.info { color: var(--primary); }

        .links-section {
            margin-top: 30px;
            padding: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
        }

        .links-section h4 {
            margin-bottom: 15px;
            color: #60a5fa;
        }

        .link-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .link-item a {
            color: #60a5fa;
            text-decoration: none;
        }

        .link-item a:hover {
            text-decoration: underline;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .running { animation: pulse 1.5s infinite; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ›ï¸ AI Architect Designer</h1>
            <p>Ù†Ø¸Ø§Ù… ØªØµÙ…ÙŠÙ… Ù…Ø¹Ù…Ø§Ø±ÙŠ Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</p>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <span class="status-dot" id="serverStatus"></span>
                <span id="serverText">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</span>
            </div>
            <div class="status-item">
                <span>ğŸ“¡</span>
                <span id="apiUrl">http://localhost:8001</span>
            </div>
        </div>

        <div class="grid">
            <!-- Project Input -->
            <div class="card">
                <h3>ğŸ“‹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</h3>
                <div class="form-group">
                    <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</label>
                    <input type="text" id="projectName" value="Ø¨Ø±Ø¬ Ø§Ù„Ù…ÙƒØ§ØªØ¨ Ø§Ù„Ø°ÙƒÙŠ">
                </div>
                <div class="form-group">
                    <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¨Ù†Ù‰</label>
                    <select id="buildingType">
                        <option value="office">Ù…ÙƒØªØ¨ÙŠ</option>
                        <option value="residential">Ø³ÙƒÙ†ÙŠ</option>
                        <option value="commercial">ØªØ¬Ø§Ø±ÙŠ</option>
                        <option value="mixed">Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</option>
                        <option value="hospital">Ù…Ø³ØªØ´ÙÙ‰</option>
                        <option value="educational">ØªØ¹Ù„ÙŠÙ…ÙŠ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø·ÙˆØ§Ø¨Ù‚</label>
                    <input type="number" id="floors" value="12" min="1" max="100">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„ÙƒÙ„ÙŠØ© (Ù…Â²)</label>
                    <input type="number" id="totalArea" value="15000" min="100">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ù…ÙˆÙ‚Ø¹</label>
                    <select id="location">
                        <option value="riyadh">Ø§Ù„Ø±ÙŠØ§Ø¶</option>
                        <option value="jeddah">Ø¬Ø¯Ø©</option>
                        <option value="dubai">Ø¯Ø¨ÙŠ</option>
                        <option value="doha">Ø§Ù„Ø¯ÙˆØ­Ø©</option>
                        <option value="cairo">Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ù…ØªØ·Ù„Ø¨Ø§Øª Ø®Ø§ØµØ©</label>
                    <textarea id="requirements" rows="3" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø±Ø§Ø¹Ø§Ø© Ø§Ù„Ø§Ø³ØªØ¯Ø§Ù…Ø©ØŒ ØªØµÙ…ÙŠÙ… Ø­Ø¯ÙŠØ«ØŒ Ø¥Ø¶Ø§Ø¡Ø© Ø·Ø¨ÙŠØ¹ÙŠØ©..."></textarea>
                </div>
            </div>

            <!-- Agents Panel -->
            <div class="card">
                <h3>ğŸ¤– ÙˆÙƒÙ„Ø§Ø¡ Ø§Ù„ØªØµÙ…ÙŠÙ…</h3>
                <div class="agents-grid">
                    <div class="agent-card" id="agent-architecture">
                        <div class="agent-icon">ğŸ—ï¸</div>
                        <div class="agent-name">Ø§Ù„Ù…Ø¹Ù…Ø§Ø±ÙŠ</div>
                        <div class="agent-status pending" id="status-architecture">Ø¬Ø§Ù‡Ø²</div>
                    </div>
                    <div class="agent-card" id="agent-structural">
                        <div class="agent-icon">ğŸ”©</div>
                        <div class="agent-name">Ø§Ù„Ø¥Ù†Ø´Ø§Ø¦ÙŠ</div>
                        <div class="agent-status pending" id="status-structural">Ø¬Ø§Ù‡Ø²</div>
                    </div>
                    <div class="agent-card" id="agent-mep">
                        <div class="agent-icon">âš¡</div>
                        <div class="agent-name">MEP</div>
                        <div class="agent-status pending" id="status-mep">Ø¬Ø§Ù‡Ø²</div>
                    </div>
                    <div class="agent-card" id="agent-interior">
                        <div class="agent-icon">ğŸ›‹ï¸</div>
                        <div class="agent-name">Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ</div>
                        <div class="agent-status pending" id="status-interior">Ø¬Ø§Ù‡Ø²</div>
                    </div>
                </div>

                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">0% - Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¨Ø¯Ø¡</div>
                </div>

                <button class="btn btn-primary" id="startBtn" onclick="startDesign()">
                    ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ØªØµÙ…ÙŠÙ…
                </button>
            </div>
        </div>

        <!-- Results Panel -->
        <div class="results-panel" id="resultsPanel">
            <h3 style="margin-bottom: 20px;">ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØµÙ…ÙŠÙ…</h3>

            <div class="results-grid">
                <div class="result-item">
                    <div class="result-value" id="resultArea">-</div>
                    <div class="result-label">Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØµÙ…Ù…Ø©</div>
                </div>
                <div class="result-item">
                    <div class="result-value" id="resultFloors">-</div>
                    <div class="result-label">Ø§Ù„Ø·ÙˆØ§Ø¨Ù‚</div>
                </div>
                <div class="result-item">
                    <div class="result-value" id="resultConflicts">-</div>
                    <div class="result-label">Ø§Ù„ØªØ¹Ø§Ø±Ø¶Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙˆÙ„Ø©</div>
                </div>
                <div class="result-item">
                    <div class="result-value" id="resultTime">-</div>
                    <div class="result-label">ÙˆÙ‚Øª Ø§Ù„ØªÙ†ÙÙŠØ°</div>
                </div>
            </div>

            <div class="output-section" id="outputSection">
                <!-- Outputs will be added here -->
            </div>

            <div class="log-section" id="logSection">
                <div class="log-entry info">[INFO] Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¨Ø¯Ø¡</div>
            </div>
        </div>

        <!-- Links Section -->
        <div class="links-section">
            <h4>ğŸ”— Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù†Ø¸Ø§Ù…</h4>
            <div class="link-item">
                <span>ğŸ“¡ API Ø§Ù„Ø®Ø§Ø¯Ù…</span>
                <a href="http://localhost:8001/docs" target="_blank">http://localhost:8001/docs</a>
            </div>
            <div class="link-item">
                <span>ğŸ  Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
                <a href="index.html" target="_blank">index.html</a>
            </div>
            <div class="link-item">
                <span>ğŸ“ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„</span>
                <a href="intake.html" target="_blank">intake.html</a>
            </div>
            <div class="link-item">
                <span>ğŸ›ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span>
                <a href="orchestrator.html" target="_blank">orchestrator.html</a>
            </div>
            <div class="link-item">
                <span>ğŸ“Š Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª</span>
                <a href="outputs.html" target="_blank">outputs.html</a>
            </div>
            <div class="link-item">
                <span>ğŸ“‹ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…ÙŠ</span>
                <a href="proposal.html" target="_blank">proposal.html</a>
            </div>
            <div class="link-item" style="background: rgba(249,115,22,0.2); border: 1px solid #f97316;">
                <span>ğŸ¨ Ø¹Ø§Ø±Ø¶ Ø§Ù„ØªØµÙ…ÙŠÙ… (2D/3D)</span>
                <a href="design-viewer.html" target="_blank" style="color: #f97316; font-weight: bold;">design-viewer.html</a>
            </div>
        </div>
    </div>

    <script>
        // Auto-detect API URL (works on localhost, Vercel, and AWS)
        const API_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:8001'
            : 'https://p0hlxndk8d.execute-api.us-east-1.amazonaws.com';
        let isRunning = false;
        let currentRunId = null;

        // Check server status
        async function checkServer() {
            try {
                const response = await fetch(`${API_URL}/api/health`);
                if (response.ok) {
                    document.getElementById('serverStatus').classList.add('online');
                    document.getElementById('serverText').textContent = 'Ù…ØªØµÙ„';
                    document.getElementById('apiUrl').textContent = API_URL || window.location.origin;
                    return true;
                }
                throw new Error('Not OK');
            } catch {
                document.getElementById('serverStatus').classList.remove('online');
                document.getElementById('serverText').textContent = 'ØºÙŠØ± Ù…ØªØµÙ„';
                return false;
            }
        }

        // Add log entry
        function addLog(message, type = 'info') {
            const logSection = document.getElementById('logSection');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString('ar-SA')}] ${message}`;
            logSection.appendChild(entry);
            logSection.scrollTop = logSection.scrollHeight;
        }

        // Update agent status
        function updateAgentStatus(agent, status, text) {
            const statusEl = document.getElementById(`status-${agent}`);
            const cardEl = document.getElementById(`agent-${agent}`);
            statusEl.className = `agent-status ${status}`;
            statusEl.textContent = text;

            if (status === 'running') {
                cardEl.classList.add('running');
            } else {
                cardEl.classList.remove('running');
            }
        }

        // Update progress
        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = `${percent}%`;
            document.getElementById('progressText').textContent = `${percent}% - ${text}`;
        }

        // Poll for design completion
        async function pollForCompletion() {
            while (isRunning) {
                try {
                    const response = await fetch(`${API_URL}/api/state`);
                    if (response.ok) {
                        const state = await response.json();
                        if (state.run?.status === 'Complete') {
                            return state;
                        } else if (state.run?.status === 'Failed') {
                            throw new Error('Design failed: ' + state.run.conflicts);
                        }
                    }
                } catch (e) {
                    addLog(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…: ${e.message}`, 'error');
                }
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            return null;
        }

        // Start design process using REAL API
        async function startDesign() {
            if (isRunning) return;

            const serverOnline = await checkServer();
            if (!serverOnline) {
                addLog('Ø§Ù„Ø®Ø§Ø¯Ù… ØºÙŠØ± Ù…ØªØµÙ„ - Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø±Ø¶', 'info');
            }

            isRunning = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('startBtn').innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØµÙ…ÙŠÙ…...';
            document.getElementById('resultsPanel').classList.add('active');
            document.getElementById('outputSection').innerHTML = '';

            const project = {
                name: document.getElementById('projectName').value,
                buildingType: document.getElementById('buildingType').value,
                floors: parseInt(document.getElementById('floors').value),
                totalArea: parseInt(document.getElementById('totalArea').value),
                location: document.getElementById('location').value,
                requirements: document.getElementById('requirements').value
            };

            addLog(`Ø¨Ø¯Ø¡ ØªØµÙ…ÙŠÙ… Ù…Ø´Ø±ÙˆØ¹: ${project.name}`, 'info');
            const startTime = Date.now();

            try {
                // Step 1: Create project via API
                updateAgentStatus('architecture', 'running', 'ÙŠØ¹Ù…Ù„...');
                updateProgress(10, 'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹');
                addLog('Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù„Ù„Ø®Ø§Ø¯Ù…...', 'info');

                const projectPayload = {
                    project: {
                        name: project.name,
                        type: project.buildingType,
                        floors: String(project.floors),
                        gfa: String(project.totalArea),
                        region: project.location
                    }
                };

                const stateResponse = await fetch(`${API_URL}/api/state`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(projectPayload)
                });

                if (!stateResponse.ok) {
                    throw new Error('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹');
                }
                addLog('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ù†Ø¬Ø§Ø­', 'success');

                // Step 2: Start REAL design run
                updateProgress(20, 'Ø¨Ø¯Ø¡ Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ');
                addLog('Ø¨Ø¯Ø¡ Ù…Ø­Ø±Ùƒ Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠ...', 'info');

                const runResponse = await fetch(`${API_URL}/api/runs/start`, {
                    method: 'POST'
                });

                if (!runResponse.ok) {
                    throw new Error('ÙØ´Ù„ Ø¨Ø¯Ø¡ Ø§Ù„ØªØµÙ…ÙŠÙ…');
                }

                const runData = await runResponse.json();
                currentRunId = runData.run?.id;
                addLog(`ØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„ØªØµÙ…ÙŠÙ… - Run ID: ${currentRunId?.substring(0, 8)}...`, 'success');

                // Step 3: Poll for completion and update UI
                updateAgentStatus('architecture', 'running', 'ÙŠØµÙ…Ù…...');
                updateProgress(30, 'ØªØ­Ù„ÙŠÙ„ Ù…Ø¹Ù…Ø§Ø±ÙŠ');

                // Poll for events and update progress
                let lastEventCount = 0;
                const pollInterval = setInterval(async () => {
                    try {
                        const eventsResponse = await fetch(`${API_URL}/api/runs/${currentRunId}/events`);
                        if (eventsResponse.ok) {
                            const events = await eventsResponse.json();
                            for (let i = lastEventCount; i < events.length; i++) {
                                const event = events[i];
                                addLog(event.message, event.level === 'error' ? 'error' : event.level === 'success' ? 'success' : 'info');

                                // Update agent status based on step
                                if (event.step === 'architecture') {
                                    updateAgentStatus('architecture', 'running', 'ÙŠØµÙ…Ù…...');
                                    updateProgress(40, 'ØªØµÙ…ÙŠÙ… Ù…Ø¹Ù…Ø§Ø±ÙŠ');
                                } else if (event.step === 'structural') {
                                    updateAgentStatus('architecture', 'done', 'Ù…ÙƒØªÙ…Ù„ âœ“');
                                    updateAgentStatus('structural', 'running', 'ÙŠØµÙ…Ù…...');
                                    updateProgress(55, 'ØªØµÙ…ÙŠÙ… Ø¥Ù†Ø´Ø§Ø¦ÙŠ');
                                } else if (event.step === 'mep') {
                                    updateAgentStatus('structural', 'done', 'Ù…ÙƒØªÙ…Ù„ âœ“');
                                    updateAgentStatus('mep', 'running', 'ÙŠØµÙ…Ù…...');
                                    updateProgress(70, 'ØªØµÙ…ÙŠÙ… MEP');
                                } else if (event.step === 'finalization') {
                                    updateAgentStatus('mep', 'done', 'Ù…ÙƒØªÙ…Ù„ âœ“');
                                    updateAgentStatus('interior', 'running', 'ÙŠØµÙ…Ù…...');
                                    updateProgress(85, 'Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØµÙ…ÙŠÙ…');
                                }
                            }
                            lastEventCount = events.length;
                        }
                    } catch (e) {
                        // Ignore polling errors
                    }
                }, 500);

                // Wait for completion
                const finalState = await pollForCompletion();
                clearInterval(pollInterval);

                if (!finalState) {
                    throw new Error('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØµÙ…ÙŠÙ…');
                }

                // Step 4: Get REAL design data
                updateProgress(90, 'Ø¬Ù„Ø¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©');
                addLog('Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©...', 'info');

                const designResponse = await fetch(`${API_URL}/api/design/data`);
                if (!designResponse.ok) {
                    throw new Error('ÙØ´Ù„ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØµÙ…ÙŠÙ…');
                }

                const designData = await designResponse.json();
                addLog('ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©', 'success');

                // Display REAL results
                displayRealResults(designData, finalState.outputs, project);

                // Update agent statuses
                updateAgentStatus('architecture', 'done', 'Ù…ÙƒØªÙ…Ù„ âœ“');
                updateAgentStatus('structural', 'done', 'Ù…ÙƒØªÙ…Ù„ âœ“');
                updateAgentStatus('mep', 'done', 'Ù…ÙƒØªÙ…Ù„ âœ“');
                updateAgentStatus('interior', 'done', 'Ù…ÙƒØªÙ…Ù„ âœ“');

                const endTime = Date.now();
                const executionTime = ((endTime - startTime) / 1000).toFixed(2);

                document.getElementById('resultTime').textContent = `${executionTime} Ø«`;
                updateProgress(100, 'Ù…ÙƒØªÙ…Ù„ - Ù†ØªØ§Ø¦Ø¬ Ø­Ù‚ÙŠÙ‚ÙŠØ©');
                addLog(`ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ ÙÙŠ ${executionTime} Ø«Ø§Ù†ÙŠØ©`, 'success');

            } catch (error) {
                addLog(`Ø®Ø·Ø£: ${error.message}`, 'error');
                // Fallback to demo mode if API fails
                addLog('Ø§Ù„ØªØ­ÙˆÙ„ Ø¥Ù„Ù‰ ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙˆØ¶ÙŠØ­ÙŠ...', 'info');
                await runDemoMode(project, startTime);
            }

            isRunning = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('startBtn').innerHTML = 'ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØµÙ…ÙŠÙ…';
        }

        // Display REAL results from API
        function displayRealResults(designData, outputs, project) {
            const arch = designData.architectural;
            const struct = designData.structural;
            const mep = designData.mep;
            const coord = designData.coordination;

            // Update summary metrics
            document.getElementById('resultArea').textContent = `${Math.round(arch.massing.total_area).toLocaleString()} Ù…Â²`;
            document.getElementById('resultFloors').textContent = arch.massing.floors;
            document.getElementById('resultConflicts').textContent = `${coord.conflicts_found} â†’ ${coord.conflicts_resolved}`;

            // Clear and add REAL outputs
            const outputSection = document.getElementById('outputSection');
            outputSection.innerHTML = '';

            // Architectural output (REAL)
            addRealOutput('architecture', 'Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ø¹Ù…Ø§Ø±ÙŠ (Ø­Ù‚ÙŠÙ‚ÙŠ)', [
                `Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ù…Ø¨Ù†Ù‰: ${arch.massing.width.toFixed(1)}Ù… Ã— ${arch.massing.depth.toFixed(1)}Ù…`,
                `Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ÙƒÙ„ÙŠ: ${arch.massing.height.toFixed(1)} Ù… (${arch.massing.floors} Ø·ÙˆØ§Ø¨Ù‚)`,
                `Ù…Ø³Ø§Ø­Ø© Ø§Ù„ÙƒÙˆØ±: ${arch.core.area.toFixed(0)} Ù…Â² (${arch.core.ratio}%)`,
                `ÙƒÙØ§Ø¡Ø© Ø§Ù„Ù…Ø¨Ù†Ù‰: ${arch.efficiency}%`,
                `Ø¹Ø¯Ø¯ Ø§Ù„ÙØ±Ø§ØºØ§Øª: ${arch.spaces.length}`,
                `WWR Ø´Ù…Ø§Ù„/Ø¬Ù†ÙˆØ¨: ${(arch.facade.wwr_north * 100).toFixed(0)}% / ${(arch.facade.wwr_south * 100).toFixed(0)}%`
            ]);

            // Structural output (REAL - ACI 318)
            const avgUtil = (struct.columns.reduce((sum, c) => sum + c.utilization, 0) / struct.columns.length * 100).toFixed(0);
            addRealOutput('structural', 'Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¦ÙŠ (ACI 318-19)', [
                `Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ: ${struct.system.replace('_', ' ')}`,
                `Ø´Ø¨ÙƒØ© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: ${struct.grid.bay_x}Ù… Ã— ${struct.grid.bay_y}Ù…`,
                `Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: ${struct.columns.length} (${struct.grid.columns_x} Ã— ${struct.grid.columns_y})`,
                `Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠ: ${struct.columns[0]?.size[0]}Ã—${struct.columns[0]?.size[1]} Ù…Ù…`,
                `Ù…Ø¹Ø¯Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: ${avgUtil}%`,
                `Ø³Ù…Ø§ÙƒØ© Ø§Ù„Ø¨Ù„Ø§Ø·Ø©: ${struct.slab.thickness_mm} Ù…Ù… (${struct.slab.type})`,
                `Ø§Ù„Ø­Ù…Ù„ Ø§Ù„Ù…Ø¶Ø±ÙˆØ¨: ${struct.loads.factored_kN_m2} kN/mÂ²`,
                `Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ©: ${struct.period_s} Ø«`
            ]);

            // MEP output (REAL - ASHRAE)
            addRealOutput('mep', 'Ø£Ù†Ø¸Ù…Ø© MEP (ASHRAE)', [
                `Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙƒÙŠÙŠÙ: ${mep.hvac.system_type}`,
                `Ø­Ù…Ù„ Ø§Ù„ØªØ¨Ø±ÙŠØ¯: ${mep.hvac.total_cooling_ton.toFixed(0)} Ø·Ù† (${mep.hvac.total_cooling_kW.toFixed(0)} kW)`,
                `Ø§Ù„Ø­Ù…Ù„ Ø§Ù„Ø­Ø³Ø§Ø³: ${mep.hvac.sensible_kW.toFixed(0)} kW`,
                `Ù‡ÙˆØ§Ø¡ Ø§Ù„ØªØºØ°ÙŠØ©: ${mep.hvac.supply_air_cfm.toFixed(0)} CFM`,
                `COP: ${mep.hvac.cop}`,
                `Ø§Ù„Ø­Ù…Ù„ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${mep.electrical.total_connected_kW.toFixed(0)} kW`,
                `Ø§Ù„Ø­Ù…Ù„ Ø§Ù„Ø°Ø±ÙˆÙŠ: ${mep.electrical.peak_demand_kW.toFixed(0)} kW`,
                `Ø§Ù„Ù…Ø­ÙˆÙ„: ${mep.electrical.transformer_kVA} kVA`,
                `Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØµØ§Ø¹Ø¯: ${mep.electrical.elevator_count}`,
                `Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ù…ÙŠØ§Ù‡: ${mep.plumbing.water_demand_Lpd.toFixed(0)} Ù„ØªØ±/ÙŠÙˆÙ…`
            ]);

            // Coordination output
            addRealOutput('interior', 'Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ ÙˆØ§Ù„ØªØ¹Ø§Ø±Ø¶Ø§Øª', [
                `Ø§Ù„ØªØ¹Ø§Ø±Ø¶Ø§Øª Ø§Ù„Ù…ÙƒØªØ´ÙØ©: ${coord.conflicts_found}`,
                `Ø§Ù„ØªØ¹Ø§Ø±Ø¶Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙˆÙ„Ø©: ${coord.conflicts_resolved}`,
                `Ù†Ø³Ø¨Ø© Ø®Ù„Ùˆ Ø§Ù„ØªØ¹Ø§Ø±Ø¶Ø§Øª: ${coord.clash_free_percent}%`,
                `Ø¯Ø±Ø¬Ø© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚: ${coord.coordination_score}/100`,
                ...coord.conflicts.slice(0, 3).map(c => `âš ï¸ ${c.description}`)
            ]);

            // Add metrics badge
            if (outputs) {
                addLog(`ğŸ“Š Clash Density: ${outputs.clash_density}`, 'success');
                addLog(`ğŸ“Š Structural Variance: ${outputs.structural_variance}`, 'success');
                addLog(`ğŸ“Š Compliance: ${outputs.compliance}`, 'success');
            }
        }

        // Add real output to results
        function addRealOutput(agent, title, items) {
            const outputSection = document.getElementById('outputSection');
            const div = document.createElement('div');
            div.className = `output-item ${agent}`;
            div.innerHTML = `
                <strong>${title}</strong>
                <ul style="margin: 8px 0 0 20px; font-size: 13px; color: #94a3b8;">
                    ${items.map(item => `<li>${item}</li>`).join('')}
                </ul>
            `;
            outputSection.appendChild(div);
        }

        // Fallback demo mode (when API unavailable)
        async function runDemoMode(project, startTime) {
            const agents = ['architecture', 'structural', 'mep', 'interior'];
            const agentNames = {
                architecture: 'Ø§Ù„Ù…Ø¹Ù…Ø§Ø±ÙŠ',
                structural: 'Ø§Ù„Ø¥Ù†Ø´Ø§Ø¦ÙŠ',
                mep: 'MEP',
                interior: 'Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ'
            };

            for (let i = 0; i < agents.length; i++) {
                const agent = agents[i];
                updateAgentStatus(agent, 'running', 'ÙŠØ¹Ù…Ù„...');
                updateProgress(Math.round((i / agents.length) * 100), `ØªØ´ØºÙŠÙ„ ${agentNames[agent]} (Ø¹Ø±Ø¶)`);
                addLog(`Ø¨Ø¯Ø¡ ${agentNames[agent]} (ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø±Ø¶)...`, 'info');

                await new Promise(resolve => setTimeout(resolve, 800 + Math.random() * 500));

                const output = generateDemoOutput(agent, project);
                addRealOutput(agent, output.title, output.items);

                updateAgentStatus(agent, 'done', 'Ù…ÙƒØªÙ…Ù„ âœ“');
                addLog(`${agentNames[agent]} Ø§ÙƒØªÙ…Ù„`, 'success');
            }

            const endTime = Date.now();
            const executionTime = ((endTime - startTime) / 1000).toFixed(2);
            const designedArea = Math.floor(project.totalArea * 0.87);

            document.getElementById('resultArea').textContent = `${designedArea.toLocaleString()} Ù…Â²`;
            document.getElementById('resultFloors').textContent = project.floors;
            document.getElementById('resultConflicts').textContent = '12 â†’ 8';
            document.getElementById('resultTime').textContent = `${executionTime} Ø«`;

            updateProgress(100, 'Ù…ÙƒØªÙ…Ù„ (ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø±Ø¶)');
            addLog(`ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ ÙÙŠ ${executionTime} Ø«Ø§Ù†ÙŠØ© (ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø±Ø¶)`, 'success');
        }

        // Generate demo output (fallback)
        function generateDemoOutput(agent, project) {
            const floorArea = project.totalArea / project.floors;

            switch(agent) {
                case 'architecture':
                    return {
                        title: 'Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ø¹Ù…Ø§Ø±ÙŠ (Ø¹Ø±Ø¶ ØªÙˆØ¶ÙŠØ­ÙŠ)',
                        items: [
                            `Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø·Ø§Ø¨Ù‚: ${Math.floor(floorArea)} Ù…Â²`,
                            `Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ù…Ø¨Ù†Ù‰: ${Math.floor(Math.sqrt(floorArea) * 1.2)}Ù… Ã— ${Math.floor(Math.sqrt(floorArea) * 0.85)}Ù…`,
                            `Ù†Ø³Ø¨Ø© Ø§Ù„ÙƒÙˆØ±: 18%`,
                            `Ø§Ù„Ø§Ø±ØªÙØ§Ø¹: ${(project.floors * 3.6).toFixed(1)} Ù…`
                        ]
                    };
                case 'structural':
                    return {
                        title: 'Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¦ÙŠ (Ø¹Ø±Ø¶ ØªÙˆØ¶ÙŠØ­ÙŠ)',
                        items: [
                            `Ø§Ù„Ù†Ø¸Ø§Ù…: ${project.floors > 10 ? 'Core + Outrigger' : 'Moment Frame'}`,
                            `Ø´Ø¨ÙƒØ© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: 8.4Ù… Ã— 8.4Ù…`,
                            `Ø³Ù…Ø§ÙƒØ© Ø§Ù„Ø¨Ù„Ø§Ø·Ø©: 200 Ù…Ù…`
                        ]
                    };
                case 'mep':
                    return {
                        title: 'Ø£Ù†Ø¸Ù…Ø© MEP (Ø¹Ø±Ø¶ ØªÙˆØ¶ÙŠØ­ÙŠ)',
                        items: [
                            `Ø­Ù…Ù„ Ø§Ù„ØªØ¨Ø±ÙŠØ¯: ${Math.floor(project.totalArea * 0.12)} Ø·Ù†`,
                            `Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙƒÙŠÙŠÙ: VRF`,
                            `Ø§Ù„Ù…Ø­ÙˆÙ„: ${Math.ceil(project.totalArea * 0.08 / 100) * 100} kVA`
                        ]
                    };
                case 'interior':
                    return {
                        title: 'Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ (Ø¹Ø±Ø¶ ØªÙˆØ¶ÙŠØ­ÙŠ)',
                        items: [
                            `ÙƒÙØ§Ø¡Ø© Ø§Ù„Ù…Ø³Ø§Ø­Ø©: 85%`,
                            `Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙƒØ§ØªØ¨: ${Math.floor(project.totalArea / 15)}`
                        ]
                    };
            }
        }

        // Initialize
        checkServer();
        setInterval(checkServer, 5000);
    </script>
</body>
</html>
