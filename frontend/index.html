<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Architect Designer</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        :root {
            --primary: #f97316;
            --primary-dark: #ea580c;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-panel: #334155;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #475569;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 0 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 64px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        .brand-text {
            font-size: 18px;
            font-weight: 600;
        }

        /* Step Navigation */
        .steps-nav {
            display: flex;
            gap: 4px;
            background: var(--bg-panel);
            padding: 4px;
            border-radius: 10px;
        }

        .step-btn {
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 8px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .step-btn:hover { background: rgba(255,255,255,0.05); }
        .step-btn.active { background: var(--primary); color: white; }
        .step-btn.completed { color: var(--success); }
        .step-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .step-num {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .step-btn.active .step-num { background: rgba(255,255,255,0.2); }
        .step-btn.completed .step-num { background: var(--success); }

        .server-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--error);
        }

        .status-dot.online { background: var(--success); }

        /* Main Content */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .step-content {
            display: none;
            flex: 1;
        }

        .step-content.active {
            display: flex;
            flex-direction: column;
        }

        /* Step 1: Input Form */
        .input-step {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 24px;
            width: 100%;
        }

        .step-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .step-header h1 {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .step-header p {
            color: var(--text-muted);
            font-size: 16px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group.full { grid-column: 1 / -1; }

        .form-group label {
            font-size: 14px;
            color: var(--text-muted);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px 16px;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 15px;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(249,115,22,0.4); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        .btn-secondary {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            color: var(--text);
        }

        .btn-secondary:hover { background: var(--border); }

        .form-actions {
            margin-top: 32px;
            display: flex;
            justify-content: center;
        }

        /* Step 2: Design Progress */
        .progress-step {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 24px;
            width: 100%;
        }

        .agents-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 32px;
        }

        .agent-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
        }

        .agent-card.running {
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(249,115,22,0.2);
        }

        .agent-card.completed {
            border-color: var(--success);
        }

        .agent-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .agent-name {
            font-weight: 600;
            margin-bottom: 8px;
        }

        .agent-status {
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 20px;
            background: var(--bg-panel);
            color: var(--text-muted);
            display: inline-block;
        }

        .agent-status.running { background: rgba(249,115,22,0.2); color: var(--primary); }
        .agent-status.completed { background: rgba(16,185,129,0.2); color: var(--success); }

        .progress-container {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .progress-bar {
            height: 8px;
            background: var(--bg-panel);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--success));
            border-radius: 4px;
            transition: width 0.5s ease;
            width: 0%;
        }

        .progress-text {
            text-align: center;
            color: var(--text-muted);
            font-size: 14px;
        }

        .log-section {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 6px;
            font-size: 13px;
            font-family: monospace;
        }

        .log-entry.info { background: rgba(59,130,246,0.1); color: #60a5fa; }
        .log-entry.success { background: rgba(16,185,129,0.1); color: var(--success); }
        .log-entry.error { background: rgba(239,68,68,0.1); color: var(--error); }

        /* Step 3: Results Viewer */
        .results-step {
            flex: 1;
            display: grid;
            grid-template-columns: 240px 1fr 260px;
            grid-template-rows: auto 1fr;
            height: calc(100vh - 64px);
        }

        .view-tabs {
            grid-column: 1 / -1;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 12px 24px;
            display: flex;
            gap: 8px;
        }

        .view-tab {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .view-tab:hover { border-color: var(--primary); color: var(--text); }
        .view-tab.active { background: var(--primary); border-color: var(--primary); color: white; }

        .left-panel, .right-panel {
            background: var(--bg-card);
            border-left: 1px solid var(--border);
            padding: 16px;
            overflow-y: auto;
        }

        .right-panel {
            border-left: none;
            border-right: 1px solid var(--border);
        }

        .panel-section {
            margin-bottom: 24px;
        }

        .panel-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .layer-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: var(--bg-panel);
            border-radius: 8px;
            margin-bottom: 6px;
        }

        .layer-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .layer-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .layer-toggle {
            width: 40px;
            height: 22px;
            background: var(--border);
            border-radius: 11px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
        }

        .layer-toggle.active { background: var(--primary); }

        .layer-toggle::after {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            top: 2px;
            right: 2px;
            transition: right 0.2s;
        }

        .layer-toggle.active::after { right: 20px; }

        .viewer-area {
            background: #1a1a2e;
            position: relative;
            overflow: hidden;
        }

        .viewer-2d, .viewer-3d, .viewer-section, .viewer-elevation {
            width: 100%;
            height: 100%;
            display: none;
        }

        .viewer-2d.active, .viewer-3d.active, .viewer-section.active, .viewer-elevation.active {
            display: block;
        }

        #svg-2d, #svg-section, #svg-elevation {
            width: 100%;
            height: 100%;
            background: #fff;
        }

        #canvas-3d {
            width: 100%;
            height: 100%;
        }

        .viewer-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            background: var(--bg-card);
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .control-btn {
            width: 36px;
            height: 36px;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
        }

        .control-btn:hover { background: var(--primary); border-color: var(--primary); }

        .zoom-display {
            padding: 0 12px;
            display: flex;
            align-items: center;
            font-size: 13px;
            color: var(--text-muted);
        }

        .property-group {
            background: var(--bg-panel);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .property-group-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .property-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
        }

        .property-row:last-child { border-bottom: none; }
        .property-label { color: var(--text-muted); }
        .property-value { font-weight: 500; }

        /* Step 4: Export */
        .export-step {
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 24px;
            width: 100%;
        }

        .export-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 32px;
        }

        .export-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
        }

        .export-card:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
        }

        .export-icon {
            font-size: 40px;
            margin-bottom: 16px;
        }

        .export-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .export-desc {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .export-btn {
            width: 100%;
            padding: 10px;
            background: var(--primary);
            border: none;
            border-radius: 6px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .export-btn:hover { background: var(--primary-dark); }

        .summary-section {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 24px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }

        .summary-item {
            text-align: center;
            padding: 16px;
            background: var(--bg-panel);
            border-radius: 8px;
        }

        .summary-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .summary-label {
            font-size: 12px;
            color: var(--text-muted);
        }

        .info-badge {
            position: absolute;
            top: 16px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            color: var(--text-muted);
            z-index: 10;
        }

        .info-badge strong { color: var(--primary); }

        .tool-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .tool-btn {
            aspect-ratio: 1;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text);
        }

        .tool-btn:hover { border-color: var(--primary); }
        .tool-btn.active { background: var(--primary); border-color: var(--primary); }
        .tool-icon { font-size: 18px; }
        .tool-label { font-size: 9px; color: var(--text-muted); }
        .tool-btn.active .tool-label { color: white; }

        @media (max-width: 1024px) {
            .results-step { grid-template-columns: 1fr; }
            .left-panel, .right-panel { display: none; }
            .agents-grid { grid-template-columns: repeat(2, 1fr); }
            .export-grid { grid-template-columns: repeat(2, 1fr); }
            .summary-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 640px) {
            .steps-nav { display: none; }
            .form-grid { grid-template-columns: 1fr; }
            .agents-grid { grid-template-columns: 1fr; }
            .export-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <header>
        <div class="brand">
            <div class="brand-icon">AI</div>
            <span class="brand-text">Architect Designer</span>
        </div>

        <nav class="steps-nav">
            <button class="step-btn active" data-step="input" onclick="goToStep('input')">
                <span class="step-num">1</span>
                Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
            </button>
            <button class="step-btn" data-step="design" onclick="goToStep('design')" disabled>
                <span class="step-num">2</span>
                Ø§Ù„ØªØµÙ…ÙŠÙ…
            </button>
            <button class="step-btn" data-step="results" onclick="goToStep('results')" disabled>
                <span class="step-num">3</span>
                Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª
            </button>
            <button class="step-btn" data-step="export" onclick="goToStep('export')" disabled>
                <span class="step-num">4</span>
                Ø§Ù„ØªØµØ¯ÙŠØ±
            </button>
        </nav>

        <div class="server-status">
            <span class="status-dot" id="statusDot"></span>
            <span id="statusText">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</span>
        </div>
    </header>

    <main>
        <!-- Step 1: Input Form -->
        <section class="step-content active" id="step-input">
            <div class="input-step">
                <div class="step-header">
                    <h1>Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯</h1>
                    <p>Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø°ÙƒÙŠ</p>
                </div>

                <form id="projectForm" class="form-grid">
                    <div class="form-group">
                        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</label>
                        <input type="text" id="projectName" value="Ù…Ø¨Ù†Ù‰ Ø§Ù„Ù…ÙƒØ§ØªØ¨" required>
                    </div>
                    <div class="form-group">
                        <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¨Ù†Ù‰</label>
                        <select id="buildingType">
                            <option value="office">Ù…ÙƒØ§ØªØ¨</option>
                            <option value="residential">Ø³ÙƒÙ†ÙŠ</option>
                            <option value="retail">ØªØ¬Ø§Ø±ÙŠ</option>
                            <option value="hotel">ÙÙ†Ø¯Ù‚</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© (Ù…Â²)</label>
                        <input type="number" id="totalArea" value="5000" min="100" required>
                    </div>
                    <div class="form-group">
                        <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø·ÙˆØ§Ø¨Ù‚</label>
                        <input type="number" id="floors" value="10" min="1" max="100" required>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ù…ÙˆÙ‚Ø¹</label>
                        <select id="location">
                            <option value="riyadh">Ø§Ù„Ø±ÙŠØ§Ø¶</option>
                            <option value="jeddah">Ø¬Ø¯Ø©</option>
                            <option value="dubai">Ø¯Ø¨ÙŠ</option>
                            <option value="cairo">Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¦ÙŠ</label>
                        <select id="structuralSystem">
                            <option value="concrete">Ø®Ø±Ø³Ø§Ù†ÙŠ</option>
                            <option value="steel">Ø­Ø¯ÙŠØ¯ÙŠ</option>
                        </select>
                    </div>
                    <div class="form-group full">
                        <label>Ù…ØªØ·Ù„Ø¨Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</label>
                        <textarea id="requirements" placeholder="Ø£ÙŠ Ù…ØªØ·Ù„Ø¨Ø§Øª Ø®Ø§ØµØ©..."></textarea>
                    </div>
                </form>

                <div class="form-actions">
                    <button class="btn btn-primary" onclick="startDesign()" id="startBtn">
                        Ø¨Ø¯Ø¡ Ø§Ù„ØªØµÙ…ÙŠÙ…
                    </button>
                </div>
            </div>
        </section>

        <!-- Step 2: Design Progress -->
        <section class="step-content" id="step-design">
            <div class="progress-step">
                <div class="step-header">
                    <h1>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØµÙ…ÙŠÙ…...</h1>
                    <p>Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡ Ø§Ù„Ø°ÙƒÙŠÙˆÙ† ÙŠØ¹Ù…Ù„ÙˆÙ† Ø¹Ù„Ù‰ ØªØµÙ…ÙŠÙ… Ù…Ø´Ø±ÙˆØ¹Ùƒ</p>
                </div>

                <div class="agents-grid">
                    <div class="agent-card" id="agent-arch">
                        <div class="agent-icon">ğŸ›ï¸</div>
                        <div class="agent-name">Ø§Ù„Ù…Ø¹Ù…Ø§Ø±ÙŠ</div>
                        <div class="agent-status" id="status-arch">Ø¬Ø§Ù‡Ø²</div>
                    </div>
                    <div class="agent-card" id="agent-struct">
                        <div class="agent-icon">ğŸ—ï¸</div>
                        <div class="agent-name">Ø§Ù„Ø¥Ù†Ø´Ø§Ø¦ÙŠ</div>
                        <div class="agent-status" id="status-struct">Ø¬Ø§Ù‡Ø²</div>
                    </div>
                    <div class="agent-card" id="agent-mep">
                        <div class="agent-icon">âš¡</div>
                        <div class="agent-name">MEP</div>
                        <div class="agent-status" id="status-mep">Ø¬Ø§Ù‡Ø²</div>
                    </div>
                    <div class="agent-card" id="agent-coord">
                        <div class="agent-icon">ğŸ”„</div>
                        <div class="agent-name">Ø§Ù„ØªÙ†Ø³ÙŠÙ‚</div>
                        <div class="agent-status" id="status-coord">Ø¬Ø§Ù‡Ø²</div>
                    </div>
                </div>

                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">0% - Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¨Ø¯Ø¡</div>
                </div>

                <div class="log-section" id="logSection">
                    <div class="log-entry info">[Ù†Ø¸Ø§Ù…] Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¨Ø¯Ø¡</div>
                </div>
            </div>
        </section>

        <!-- Step 3: Results Viewer -->
        <section class="step-content" id="step-results">
            <div class="results-step">
                <div class="view-tabs">
                    <button class="view-tab active" data-view="2d" onclick="switchView('2d')">2D Plan</button>
                    <button class="view-tab" data-view="3d" onclick="switchView('3d')">3D Model</button>
                    <button class="view-tab" data-view="section" onclick="switchView('section')">Sections</button>
                    <button class="view-tab" data-view="elevation" onclick="switchView('elevation')">Elevations</button>
                    <div style="flex:1"></div>
                    <button class="btn btn-primary" onclick="goToStep('export')" style="padding: 8px 16px; font-size: 14px;">Ø§Ù„ØªØµØ¯ÙŠØ±</button>
                </div>

                <aside class="right-panel">
                    <div class="panel-section">
                        <h3 class="panel-title">Ø§Ù„Ø·Ø¨Ù‚Ø§Øª</h3>
                        <div class="layer-item">
                            <div class="layer-info">
                                <div class="layer-color" style="background: #3b82f6"></div>
                                <span>Ù…Ø¹Ù…Ø§Ø±ÙŠ</span>
                            </div>
                            <div class="layer-toggle active" data-layer="architectural" onclick="toggleLayer(this)"></div>
                        </div>
                        <div class="layer-item">
                            <div class="layer-info">
                                <div class="layer-color" style="background: #ef4444"></div>
                                <span>Ø¥Ù†Ø´Ø§Ø¦ÙŠ</span>
                            </div>
                            <div class="layer-toggle active" data-layer="structural" onclick="toggleLayer(this)"></div>
                        </div>
                        <div class="layer-item">
                            <div class="layer-info">
                                <div class="layer-color" style="background: #10b981"></div>
                                <span>MEP</span>
                            </div>
                            <div class="layer-toggle active" data-layer="mep" onclick="toggleLayer(this)"></div>
                        </div>
                        <div class="layer-item">
                            <div class="layer-info">
                                <div class="layer-color" style="background: #8b5cf6"></div>
                                <span>Ø§Ù„Ø´Ø¨ÙƒØ©</span>
                            </div>
                            <div class="layer-toggle active" data-layer="grid" onclick="toggleLayer(this)"></div>
                        </div>
                    </div>

                    <div class="panel-section">
                        <h3 class="panel-title">Ø§Ù„Ø£Ø¯ÙˆØ§Øª</h3>
                        <div class="tool-grid">
                            <button class="tool-btn active" data-tool="select" onclick="setTool('select')"><span class="tool-icon">ğŸ‘†</span><span class="tool-label">Ø§Ø®ØªÙŠØ§Ø±</span></button>
                            <button class="tool-btn" data-tool="pan" onclick="setTool('pan')"><span class="tool-icon">âœ‹</span><span class="tool-label">ØªØ­Ø±ÙŠÙƒ</span></button>
                            <button class="tool-btn" data-tool="zoom" onclick="setTool('zoom')"><span class="tool-icon">ğŸ”</span><span class="tool-label">ØªÙƒØ¨ÙŠØ±</span></button>
                            <button class="tool-btn" data-tool="measure" onclick="setTool('measure')"><span class="tool-icon">ğŸ“</span><span class="tool-label">Ù‚ÙŠØ§Ø³</span></button>
                            <button class="tool-btn" data-tool="info" onclick="setTool('info')"><span class="tool-icon">â„¹ï¸</span><span class="tool-label">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</span></button>
                            <button class="tool-btn" onclick="goToStep('export')"><span class="tool-icon">ğŸ“¥</span><span class="tool-label">ØªØµØ¯ÙŠØ±</span></button>
                        </div>
                    </div>
                </aside>

                <div class="viewer-area">
                    <div class="info-badge"><strong id="viewTitle">Floor Plan</strong> - <span id="viewInfo">Scale 1:100</span></div>

                    <div class="viewer-2d active" id="viewer-2d">
                        <svg id="svg-2d" viewBox="0 0 800 600" onclick="handleSVGClick(event, this)"></svg>
                    </div>
                    <div class="viewer-3d" id="viewer-3d">
                        <canvas id="canvas-3d"></canvas>
                    </div>
                    <div class="viewer-section" id="viewer-section">
                        <svg id="svg-section" viewBox="0 0 800 500" onclick="handleSVGClick(event, this)"></svg>
                    </div>
                    <div class="viewer-elevation" id="viewer-elevation">
                        <svg id="svg-elevation" viewBox="0 0 800 500" onclick="handleSVGClick(event, this)"></svg>
                    </div>

                    <div class="viewer-controls">
                        <button class="control-btn" onclick="zoomIn()">+</button>
                        <button class="control-btn" onclick="zoomOut()">-</button>
                        <div class="zoom-display"><span id="zoomLevel">100</span>%</div>
                        <button class="control-btn" onclick="fitView()">âŠ¡</button>
                        <button class="control-btn" onclick="resetView()">â†º</button>
                    </div>
                </div>

                <aside class="left-panel">
                    <div class="panel-section">
                        <h3 class="panel-title">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</h3>
                        <div class="property-group">
                            <div class="property-group-title">Ø§Ù„Ù…Ø¨Ù†Ù‰</div>
                            <div class="property-row"><span class="property-label">Ø§Ù„Ø§Ø³Ù…</span><span class="property-value" id="prop-name">-</span></div>
                            <div class="property-row"><span class="property-label">Ø§Ù„Ù†ÙˆØ¹</span><span class="property-value" id="prop-type">-</span></div>
                            <div class="property-row"><span class="property-label">Ø§Ù„Ø·ÙˆØ§Ø¨Ù‚</span><span class="property-value" id="prop-floors">-</span></div>
                            <div class="property-row"><span class="property-label">Ø§Ù„Ù…Ø³Ø§Ø­Ø©</span><span class="property-value" id="prop-area">-</span></div>
                            <div class="property-row"><span class="property-label">Ø§Ù„Ø§Ø±ØªÙØ§Ø¹</span><span class="property-value" id="prop-height">-</span></div>
                        </div>
                    </div>

                    <div class="panel-section">
                        <h3 class="panel-title">Ø§Ù„Ø¥Ù†Ø´Ø§Ø¦ÙŠ</h3>
                        <div class="property-group">
                            <div class="property-group-title">Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©</div>
                            <div class="property-row"><span class="property-label">Ø§Ù„Ø¹Ø¯Ø¯</span><span class="property-value" id="prop-columns">-</span></div>
                            <div class="property-row"><span class="property-label">Ø§Ù„Ø´Ø¨ÙƒØ©</span><span class="property-value" id="prop-grid">-</span></div>
                            <div class="property-row"><span class="property-label">Ø§Ù„Ø­Ø¬Ù…</span><span class="property-value" id="prop-colsize">-</span></div>
                        </div>
                    </div>

                    <div class="panel-section">
                        <h3 class="panel-title">MEP</h3>
                        <div class="property-group">
                            <div class="property-group-title">Ø§Ù„ØªÙƒÙŠÙŠÙ</div>
                            <div class="property-row"><span class="property-label">Ø§Ù„Ù†Ø¸Ø§Ù…</span><span class="property-value" id="prop-hvac">-</span></div>
                            <div class="property-row"><span class="property-label">Ø§Ù„Ù‚Ø¯Ø±Ø©</span><span class="property-value" id="prop-cooling">-</span></div>
                            <div class="property-row"><span class="property-label">Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</span><span class="property-value" id="prop-electrical">-</span></div>
                        </div>
                    </div>
                </aside>
            </div>
        </section>

        <!-- Step 4: Export -->
        <section class="step-content" id="step-export">
            <div class="export-step">
                <div class="step-header">
                    <h1>ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª</h1>
                    <p>Ø­Ù…Ù‘Ù„ Ù…Ù„ÙØ§Øª Ø§Ù„ØªØµÙ…ÙŠÙ… Ø¨Ø§Ù„ØµÙŠØºØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</p>
                </div>

                <div class="export-grid">
                    <div class="export-card" onclick="exportDWG()">
                        <div class="export-icon">ğŸ“</div>
                        <div class="export-title">DWG/DXF</div>
                        <div class="export-desc">Ù…Ù„Ù AutoCAD Ù„Ù„Ø±Ø³ÙˆÙ…Ø§Øª 2D</div>
                        <button class="export-btn">ØªØ­Ù…ÙŠÙ„</button>
                    </div>
                    <div class="export-card" onclick="exportPDF()">
                        <div class="export-icon">ğŸ“„</div>
                        <div class="export-title">PDF</div>
                        <div class="export-desc">Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø±Ø³ÙˆÙ…Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©</div>
                        <button class="export-btn">ØªØ­Ù…ÙŠÙ„</button>
                    </div>
                    <div class="export-card" onclick="exportIFC()">
                        <div class="export-icon">ğŸ—ï¸</div>
                        <div class="export-title">IFC</div>
                        <div class="export-desc">Ù†Ù…ÙˆØ°Ø¬ BIM Ù„Ù„Ù€ Revit</div>
                        <button class="export-btn">ØªØ­Ù…ÙŠÙ„</button>
                    </div>
                    <div class="export-card" onclick="exportSchedules()">
                        <div class="export-icon">ğŸ“‹</div>
                        <div class="export-title">Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„</div>
                        <div class="export-desc">Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„ØºØ±Ù ÙˆØ§Ù„Ø£Ø¹Ù…Ø¯Ø©</div>
                        <button class="export-btn">ØªØ­Ù…ÙŠÙ„</button>
                    </div>
                    <div class="export-card" onclick="exportBOQ()">
                        <div class="export-icon">ğŸ“Š</div>
                        <div class="export-title">BOQ</div>
                        <div class="export-desc">Ø­ØµØ± Ø§Ù„ÙƒÙ…ÙŠØ§Øª ÙˆØ§Ù„ØªÙƒÙ„ÙØ©</div>
                        <button class="export-btn">ØªØ­Ù…ÙŠÙ„</button>
                    </div>
                    <div class="export-card" onclick="exportAll()">
                        <div class="export-icon">ğŸ“¦</div>
                        <div class="export-title">Ø§Ù„ÙƒÙ„</div>
                        <div class="export-desc">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª ÙÙŠ ZIP</div>
                        <button class="export-btn">ØªØ­Ù…ÙŠÙ„</button>
                    </div>
                </div>

                <div class="summary-section">
                    <h3 style="margin-bottom: 16px;">Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-value" id="sum-area">-</div>
                            <div class="summary-label">Ø§Ù„Ù…Ø³Ø§Ø­Ø© (Ù…Â²)</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value" id="sum-floors">-</div>
                            <div class="summary-label">Ø§Ù„Ø·ÙˆØ§Ø¨Ù‚</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value" id="sum-columns">-</div>
                            <div class="summary-label">Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value" id="sum-cooling">-</div>
                            <div class="summary-label">Ø§Ù„ØªØ¨Ø±ÙŠØ¯ (Ø·Ù†)</div>
                        </div>
                    </div>
                </div>

                <div class="form-actions" style="margin-top: 32px;">
                    <button class="btn btn-secondary" onclick="goToStep('results')" style="margin-left: 16px;">
                        Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ø®Ø±Ø¬Ø§Øª
                    </button>
                    <button class="btn btn-primary" onclick="startNewProject()">
                        Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯
                    </button>
                </div>
            </div>
        </section>
    </main>

    <script>
        const API_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:8001'
            : 'https://p0hlxndk8d.execute-api.us-east-1.amazonaws.com';

        let currentStep = 'input';
        let designData = null;
        let projectData = null;
        let scene, camera, renderer, controls;
        let zoomLevel = 100;
        let layers = { architectural: true, structural: true, mep: true, grid: true };

        // SVG Pan/Zoom state
        let viewBox = { x: 0, y: 0, width: 800, height: 600 };
        let isPanning = false;
        let panStart = { x: 0, y: 0 };
        let currentTool = 'select';

        document.addEventListener('DOMContentLoaded', () => {
            checkServer();
            setInterval(checkServer, 30000);
        });

        async function checkServer() {
            try {
                const response = await fetch(`${API_URL}/api/health`);
                if (response.ok) {
                    document.getElementById('statusDot').classList.add('online');
                    document.getElementById('statusText').textContent = 'Ù…ØªØµÙ„';
                    return true;
                }
            } catch (e) {}
            document.getElementById('statusDot').classList.remove('online');
            document.getElementById('statusText').textContent = 'ØºÙŠØ± Ù…ØªØµÙ„';
            return false;
        }

        function goToStep(step) {
            const btn = document.querySelector(`.step-btn[data-step="${step}"]`);
            if (btn && btn.disabled) return;

            currentStep = step;
            document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.step-btn').forEach(el => el.classList.remove('active'));

            document.getElementById(`step-${step}`).classList.add('active');
            document.querySelector(`.step-btn[data-step="${step}"]`).classList.add('active');

            if (step === 'results' && designData) {
                setTimeout(() => {
                    render2DPlan();
                    renderSection();
                    renderElevation();
                    if (!scene) init3DViewer();
                }, 100);
            }
        }

        function enableStep(step) {
            const btn = document.querySelector(`.step-btn[data-step="${step}"]`);
            if (btn) btn.disabled = false;
        }

        function completeStep(step) {
            const btn = document.querySelector(`.step-btn[data-step="${step}"]`);
            if (btn) btn.classList.add('completed');
        }

        async function startDesign() {
            const btn = document.getElementById('startBtn');
            btn.disabled = true;
            btn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø¯Ø¡...';

            projectData = {
                name: document.getElementById('projectName').value,
                type: document.getElementById('buildingType').value,
                floors: parseInt(document.getElementById('floors').value) || 1,
                gfa: parseFloat(document.getElementById('totalArea').value) || 1000,
                region: document.getElementById('location').value
            };

            completeStep('input');
            enableStep('design');
            goToStep('design');

            await runDesignPipeline();
        }

        async function runDesignPipeline() {
            addLog('Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØµÙ…ÙŠÙ…...', 'info');
            updateProgress(5, 'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹...');

            try {
                // 1. Save project state
                updateAgent('arch', 'running', 'ÙŠØ¹Ù…Ù„...');
                const stateResponse = await fetch(`${API_URL}/api/state`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ project: projectData })
                });

                if (!stateResponse.ok) {
                    throw new Error('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹');
                }

                updateProgress(15, 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹');
                addLog('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ù†Ø¬Ø§Ø­', 'success');

                // 2. Start the run
                updateProgress(20, 'Ø¨Ø¯Ø¡ Ø§Ù„ØªØµÙ…ÙŠÙ…...');
                const startResponse = await fetch(`${API_URL}/api/runs/start`, { method: 'POST' });

                if (!startResponse.ok) {
                    throw new Error('ÙØ´Ù„ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„ØªØµÙ…ÙŠÙ…');
                }

                const runData = await startResponse.json();
                const runId = runData.run?.id;
                addLog('Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡', 'info');

                // 3. Track REAL progress from backend events
                await trackRealProgress(runId);

                // 4. Get design data AFTER pipeline completes
                updateProgress(90, 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬...');
                const dataResponse = await fetch(`${API_URL}/api/design/data`);

                if (!dataResponse.ok) {
                    throw new Error('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØµÙ…ÙŠÙ… - Ø§Ù„Ù€ API Ù„Ù… ÙŠØ±Ø¬Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª');
                }

                designData = await dataResponse.json();
                addLog('ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©', 'success');

                updateProgress(100, 'Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªØµÙ…ÙŠÙ…!');
                updateAgent('coord', 'completed', 'Ù…ÙƒØªÙ…Ù„');
                addLog('Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªØµÙ…ÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­!', 'success');

                completeStep('design');
                enableStep('results');
                enableStep('export');

                updatePropertiesPanel();
                updateSummary();

                setTimeout(() => goToStep('results'), 1500);

            } catch (error) {
                addLog(`Ø®Ø·Ø£: ${error.message}`, 'error');
                // Show error to user - NO SILENT DEMO FALLBACK
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message + '\n\nØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù€ Backend Ø´ØºØ§Ù„.');

                // Still allow navigation but show warning
                completeStep('design');
                enableStep('results');
                enableStep('export');

                // Use demo data but warn user
                designData = getDemoData();
                addLog('âš ï¸ ØªØ­Ø°ÙŠØ±: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø¨Ø³Ø¨Ø¨ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'warning');

                updatePropertiesPanel();
                updateSummary();
                setTimeout(() => goToStep('results'), 1500);
            }
        }

        async function trackRealProgress(runId) {
            const stepProgress = {
                'architecture': 30,
                'structural': 55,
                'mep': 75,
                'finalization': 100
            };

            const stepAgents = {
                'architecture': 'arch',
                'structural': 'struct',
                'mep': 'mep',
                'finalization': 'coord'
            };

            let lastStep = '';
            let attempts = 0;
            const maxAttempts = 30; // 30 seconds timeout

            while (attempts < maxAttempts) {
                try {
                    const response = await fetch(`${API_URL}/api/runs/${runId}/events`);

                    if (response.ok) {
                        const events = await response.json();

                        if (events && events.length > 0) {
                            const lastEvent = events[events.length - 1];
                            const step = lastEvent.step || '';
                            const message = lastEvent.message || '';

                            // Update progress
                            const progress = stepProgress[step] || 50;
                            updateProgress(progress, message);

                            // Update agent status
                            if (step !== lastStep && stepAgents[step]) {
                                if (lastStep && stepAgents[lastStep]) {
                                    updateAgent(stepAgents[lastStep], 'completed', 'Ù…ÙƒØªÙ…Ù„');
                                }
                                updateAgent(stepAgents[step], 'running', 'ÙŠØ¹Ù…Ù„...');
                                lastStep = step;
                            }

                            addLog(message, lastEvent.level === 'success' ? 'success' : 'info');

                            // Check if complete
                            if (step === 'finalization') {
                                updateAgent('coord', 'completed', 'Ù…ÙƒØªÙ…Ù„');
                                return;
                            }
                        }
                    }
                } catch (e) {
                    // Ignore polling errors
                }

                await sleep(1000);
                attempts++;
            }

            // Timeout - assume complete
            addLog('Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± - Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©...', 'info');
        }

        // simulateProgress removed - now using trackRealProgress with backend events

        function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = `${percent}%`;
            document.getElementById('progressText').textContent = `${percent}% - ${text}`;
        }

        function updateAgent(agent, status, text) {
            const card = document.getElementById(`agent-${agent}`);
            const statusEl = document.getElementById(`status-${agent}`);
            card.className = `agent-card ${status}`;
            statusEl.className = `agent-status ${status}`;
            statusEl.textContent = text;
        }

        function addLog(message, type = 'info') {
            const log = document.getElementById('logSection');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString('ar-SA')}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        function updatePropertiesPanel() {
            if (!designData) return;
            const arch = designData.architectural;
            const struct = designData.structural;
            const mep = designData.mep;

            document.getElementById('prop-name').textContent = projectData?.name || '-';
            document.getElementById('prop-type').textContent = projectData?.type || '-';
            document.getElementById('prop-floors').textContent = arch.massing.floors;
            document.getElementById('prop-area').textContent = `${arch.massing.total_area.toLocaleString()} Ù…Â²`;
            document.getElementById('prop-height').textContent = `${arch.massing.height} Ù…`;
            document.getElementById('prop-columns').textContent = struct.columns.length;
            document.getElementById('prop-grid').textContent = `${struct.grid.bay_x}Ã—${struct.grid.bay_y} Ù…`;
            document.getElementById('prop-colsize').textContent = `${struct.columns[0]?.size[0]}Ã—${struct.columns[0]?.size[1]} Ù…Ù…`;
            document.getElementById('prop-hvac').textContent = mep.hvac.system_type.replace('_', ' ');
            document.getElementById('prop-cooling').textContent = `${Math.round(mep.hvac.total_cooling_ton)} Ø·Ù†`;
            document.getElementById('prop-electrical').textContent = `${Math.round(mep.electrical.total_connected_kW)} kW`;
        }

        function updateSummary() {
            if (!designData) return;
            document.getElementById('sum-area').textContent = designData.architectural.massing.total_area.toLocaleString();
            document.getElementById('sum-floors').textContent = designData.architectural.massing.floors;
            document.getElementById('sum-columns').textContent = designData.structural.columns.length;
            document.getElementById('sum-cooling').textContent = Math.round(designData.mep.hvac.total_cooling_ton);
        }

        function switchView(view) {
            document.querySelectorAll('.view-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.view-tab[data-view="${view}"]`).classList.add('active');

            document.querySelectorAll('.viewer-2d, .viewer-3d, .viewer-section, .viewer-elevation').forEach(v => v.classList.remove('active'));
            document.getElementById(`viewer-${view}`).classList.add('active');

            const titles = { '2d': 'Floor Plan', '3d': '3D Model', 'section': 'Section', 'elevation': 'Elevation' };
            document.getElementById('viewTitle').textContent = titles[view];
        }

        function toggleLayer(el) {
            el.classList.toggle('active');
            layers[el.dataset.layer] = el.classList.contains('active');
            render2DPlan();
            update3DLayers();
        }

        function render2DPlan() {
            if (!designData) return;
            const svg = document.getElementById('svg-2d');
            const arch = designData.architectural;
            const struct = designData.structural;

            const scale = 12;
            const ox = 80, oy = 80;
            const w = arch.massing.width * scale;
            const d = arch.massing.depth * scale;

            let content = `<rect width="100%" height="100%" fill="#fff"/>`;

            if (layers.grid) {
                content += `<g stroke="#8b5cf6" stroke-width="0.5" stroke-dasharray="4,4" opacity="0.6">`;
                for (let i = 0; i <= struct.grid.columns_x; i++) {
                    const x = ox + i * struct.grid.bay_x * scale;
                    content += `<line x1="${x}" y1="${oy-20}" x2="${x}" y2="${oy+d+20}"/>`;
                    content += `<text x="${x}" y="${oy-30}" fill="#8b5cf6" font-size="11" text-anchor="middle">${String.fromCharCode(65+i)}</text>`;
                }
                for (let j = 0; j <= struct.grid.columns_y; j++) {
                    const y = oy + j * struct.grid.bay_y * scale;
                    content += `<line x1="${ox-20}" y1="${y}" x2="${ox+w+20}" y2="${y}"/>`;
                    content += `<text x="${ox-30}" y="${y+4}" fill="#8b5cf6" font-size="11" text-anchor="middle">${j+1}</text>`;
                }
                content += '</g>';
            }

            if (layers.architectural) {
                content += `<rect x="${ox}" y="${oy}" width="${w}" height="${d}" fill="none" stroke="#3b82f6" stroke-width="2"/>`;
                const cs = arch.core.side * scale;
                content += `<rect x="${ox+(w-cs)/2}" y="${oy+(d-cs)/2}" width="${cs}" height="${cs}" fill="#e2e8f0" stroke="#64748b"/>`;
                content += `<text x="${ox+w/2}" y="${oy+d/2+4}" fill="#64748b" font-size="10" text-anchor="middle">CORE</text>`;
            }

            if (layers.structural) {
                struct.columns.forEach(col => {
                    const sz = col.size[0]/1000 * scale;
                    const cx = ox + col.position[0] * scale;
                    const cy = oy + col.position[1] * scale;
                    content += `<rect x="${cx-sz/2}" y="${cy-sz/2}" width="${sz}" height="${sz}" fill="#ef4444" stroke="#b91c1c"/>`;
                });
            }

            content += `<line x1="${ox}" y1="${oy+d+40}" x2="${ox+w}" y2="${oy+d+40}" stroke="#000" stroke-width="1"/>`;
            content += `<text x="${ox+w/2}" y="${oy+d+55}" fill="#000" font-size="11" text-anchor="middle">${arch.massing.width.toFixed(1)}m</text>`;
            content += `<line x1="${ox+w+40}" y1="${oy}" x2="${ox+w+40}" y2="${oy+d}" stroke="#000" stroke-width="1"/>`;
            content += `<text x="${ox+w+50}" y="${oy+d/2}" fill="#000" font-size="11" text-anchor="middle" transform="rotate(90,${ox+w+50},${oy+d/2})">${arch.massing.depth.toFixed(1)}m</text>`;
            content += `<polygon points="${ox+w+60},${oy+10} ${ox+w+55},${oy+25} ${ox+w+65},${oy+25}" fill="#000"/>`;
            content += `<text x="${ox+w+60}" y="${oy+38}" fill="#000" font-size="10" text-anchor="middle">N</text>`;

            svg.innerHTML = content;
            svg.setAttribute('viewBox', `0 0 ${w+180} ${d+180}`);
            initSVGPan(svg);
        }

        function renderSection() {
            if (!designData) return;
            const svg = document.getElementById('svg-section');
            const arch = designData.architectural;
            const scale = 10;
            const ox = 80, oy = 40;
            const w = arch.massing.width * scale;
            const h = arch.massing.height * scale;
            const fh = h / arch.massing.floors;

            let content = `<rect width="100%" height="100%" fill="#fff"/>`;
            content += `<line x1="0" y1="${oy+h}" x2="${w+160}" y2="${oy+h}" stroke="#000" stroke-width="2"/>`;
            content += `<rect x="0" y="${oy+h}" width="${w+160}" height="20" fill="#e5e7eb"/>`;
            content += `<rect x="${ox}" y="${oy}" width="${w}" height="${h}" fill="#f8fafc" stroke="#000" stroke-width="2"/>`;

            for (let i = 0; i <= arch.massing.floors; i++) {
                const y = oy + h - i * fh;
                content += `<rect x="${ox}" y="${y-3}" width="${w}" height="6" fill="#94a3b8"/>`;
                if (i < arch.massing.floors) {
                    content += `<text x="${ox-10}" y="${y-fh/2+4}" fill="#64748b" font-size="9" text-anchor="end">L${i+1}</text>`;
                }
            }

            const cw = arch.core.side * scale;
            content += `<rect x="${ox+(w-cw)/2}" y="${oy}" width="${cw}" height="${h}" fill="#cbd5e1" stroke="#64748b"/>`;
            content += `<line x1="${ox+w+30}" y1="${oy}" x2="${ox+w+30}" y2="${oy+h}" stroke="#000"/>`;
            content += `<text x="${ox+w+40}" y="${oy+h/2}" fill="#000" font-size="11" text-anchor="start">${arch.massing.height.toFixed(1)}m</text>`;
            content += `<text x="${ox+w/2}" y="25" fill="#000" font-size="12" font-weight="bold" text-anchor="middle">SECTION A-A</text>`;

            svg.innerHTML = content;
            svg.setAttribute('viewBox', `0 0 ${w+160} ${h+80}`);
            initSVGPan(svg);
        }

        function renderElevation() {
            if (!designData) return;
            const svg = document.getElementById('svg-elevation');
            const arch = designData.architectural;
            const scale = 10;
            const ox = 80, oy = 40;
            const w = arch.massing.width * scale;
            const h = arch.massing.height * scale;
            const fh = h / arch.massing.floors;

            let content = `<rect width="100%" height="100%" fill="#fff"/>`;
            content += `<line x1="0" y1="${oy+h}" x2="${w+160}" y2="${oy+h}" stroke="#000" stroke-width="2"/>`;
            content += `<rect x="${ox}" y="${oy}" width="${w}" height="${h}" fill="#e2e8f0" stroke="#333" stroke-width="2"/>`;

            const ww = w * 0.1;
            const wh = fh * 0.5;
            for (let f = 0; f < arch.massing.floors; f++) {
                const fy = oy + h - (f+1) * fh + fh * 0.25;
                for (let i = 0; i < 5; i++) {
                    const wx = ox + w * 0.1 + i * (w * 0.18);
                    content += `<rect x="${wx}" y="${fy}" width="${ww}" height="${wh}" fill="#7dd3fc" stroke="#0284c7"/>`;
                }
            }

            content += `<text x="${ox+w/2}" y="25" fill="#000" font-size="12" font-weight="bold" text-anchor="middle">NORTH ELEVATION</text>`;

            svg.innerHTML = content;
            svg.setAttribute('viewBox', `0 0 ${w+160} ${h+80}`);
            initSVGPan(svg);
        }

        function init3DViewer() {
            if (!designData || scene) return;

            const canvas = document.getElementById('canvas-3d');
            const container = document.getElementById('viewer-3d');

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a2e);

            camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(80, 60, 80);

            renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.target.set(0, 20, 0);

            scene.add(new THREE.AmbientLight(0xffffff, 0.6));
            const directional = new THREE.DirectionalLight(0xffffff, 0.8);
            directional.position.set(50, 100, 50);
            scene.add(directional);

            scene.add(new THREE.GridHelper(100, 20, 0x8b5cf6, 0x334155));

            build3DModel();

            function animate() {
                requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            }
            animate();

            window.addEventListener('resize', () => {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            });
        }

        function build3DModel() {
            if (!designData) return;
            const arch = designData.architectural;
            const struct = designData.structural;

            const buildingGeom = new THREE.BoxGeometry(arch.massing.width, arch.massing.height, arch.massing.depth);
            const buildingMat = new THREE.MeshPhongMaterial({ color: 0x3b82f6, transparent: true, opacity: 0.3 });
            const building = new THREE.Mesh(buildingGeom, buildingMat);
            building.position.y = arch.massing.height / 2;
            building.userData = { layer: 'architectural' };
            scene.add(building);

            const coreGeom = new THREE.BoxGeometry(arch.core.side, arch.massing.height, arch.core.side);
            const coreMat = new THREE.MeshPhongMaterial({ color: 0x64748b });
            const core = new THREE.Mesh(coreGeom, coreMat);
            core.position.y = arch.massing.height / 2;
            core.userData = { layer: 'architectural' };
            scene.add(core);

            // Create columns with REAL sizes from structural data
            const colMat = new THREE.MeshPhongMaterial({ color: 0xef4444 });
            struct.columns.forEach(col => {
                // Get actual column size (in mm, convert to m)
                const colWidth = (col.size && col.size[0]) ? col.size[0] / 1000 : 0.4;
                const colDepth = (col.size && col.size[1]) ? col.size[1] / 1000 : 0.4;

                const colGeom = new THREE.BoxGeometry(colWidth, arch.massing.height, colDepth);
                const column = new THREE.Mesh(colGeom, colMat);
                column.position.set(
                    col.position[0] - arch.massing.width/2,
                    arch.massing.height / 2,
                    col.position[1] - arch.massing.depth/2
                );
                column.userData = { layer: 'structural', id: col.id, size: `${col.size[0]}x${col.size[1]}mm` };
                scene.add(column);
            });

            for (let i = 0; i <= arch.massing.floors; i++) {
                const slabGeom = new THREE.BoxGeometry(arch.massing.width, 0.25, arch.massing.depth);
                const slabMat = new THREE.MeshPhongMaterial({ color: 0x94a3b8 });
                const slab = new THREE.Mesh(slabGeom, slabMat);
                slab.position.y = i * (arch.massing.height / arch.massing.floors);
                slab.userData = { layer: 'structural' };
                scene.add(slab);
            }
        }

        function update3DLayers() {
            if (!scene) return;
            scene.traverse(obj => {
                if (obj.userData?.layer) {
                    obj.visible = layers[obj.userData.layer];
                }
            });
        }

        function zoomIn() {
            zoomLevel = Math.min(400, zoomLevel + 25);
            document.getElementById('zoomLevel').textContent = zoomLevel;
            applyZoomToSVG();
        }

        function zoomOut() {
            zoomLevel = Math.max(25, zoomLevel - 25);
            document.getElementById('zoomLevel').textContent = zoomLevel;
            applyZoomToSVG();
        }

        function fitView() {
            zoomLevel = 100;
            viewBox = { x: 0, y: 0, width: 800, height: 600 };
            document.getElementById('zoomLevel').textContent = zoomLevel;
            applyZoomToSVG();
        }

        function resetView() {
            fitView();
            if (controls) controls.reset();
        }

        function applyZoomToSVG() {
            const scale = 100 / zoomLevel;
            const centerX = viewBox.x + viewBox.width / 2;
            const centerY = viewBox.y + viewBox.height / 2;
            const newWidth = 800 * scale;
            const newHeight = 600 * scale;
            viewBox.width = newWidth;
            viewBox.height = newHeight;
            viewBox.x = centerX - newWidth / 2;
            viewBox.y = centerY - newHeight / 2;

            // Apply to all SVG viewers
            const svgs = ['svg-2d', 'svg-section', 'svg-elevation'];
            svgs.forEach(id => {
                const svg = document.getElementById(id);
                if (svg) {
                    svg.setAttribute('viewBox', `${viewBox.x} ${viewBox.y} ${viewBox.width} ${viewBox.height}`);
                }
            });
        }

        function initSVGPan(svgElement) {
            if (!svgElement || svgElement.dataset.panInit) return;
            svgElement.dataset.panInit = 'true';
            svgElement.style.cursor = 'grab';

            svgElement.addEventListener('mousedown', (e) => {
                if (currentTool !== 'pan' && currentTool !== 'select') return;
                isPanning = true;
                panStart = { x: e.clientX, y: e.clientY };
                svgElement.style.cursor = 'grabbing';
            });

            svgElement.addEventListener('mousemove', (e) => {
                if (!isPanning) return;
                const dx = (e.clientX - panStart.x) * (viewBox.width / svgElement.clientWidth);
                const dy = (e.clientY - panStart.y) * (viewBox.height / svgElement.clientHeight);
                viewBox.x -= dx;
                viewBox.y -= dy;
                svgElement.setAttribute('viewBox', `${viewBox.x} ${viewBox.y} ${viewBox.width} ${viewBox.height}`);
                panStart = { x: e.clientX, y: e.clientY };
            });

            svgElement.addEventListener('mouseup', () => {
                isPanning = false;
                svgElement.style.cursor = 'grab';
            });

            svgElement.addEventListener('mouseleave', () => {
                isPanning = false;
                svgElement.style.cursor = 'grab';
            });

            // Mouse wheel zoom
            svgElement.addEventListener('wheel', (e) => {
                e.preventDefault();
                if (e.deltaY < 0) zoomIn();
                else zoomOut();
            });
        }

        async function exportDWG() {
            try {
                const response = await fetch(`${API_URL}/api/export/dwg`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.content_base64) {
                        const binary = atob(data.content_base64);
                        const bytes = new Uint8Array(binary.length);
                        for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
                        downloadBlob(new Blob([bytes], { type: 'application/dxf' }), data.filename);
                        alert(`ØªÙ… ØªØ­Ù…ÙŠÙ„: ${data.filename}`);
                    }
                }
            } catch (e) {
                alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±');
            }
        }

        async function exportPDF() {
            try {
                // Capture the active viewer as image and create PDF
                const activeViewer = document.querySelector('.viewer-2d.active, .viewer-section.active, .viewer-elevation.active');
                if (activeViewer) {
                    const svg = activeViewer.querySelector('svg');
                    if (svg) {
                        const svgData = new XMLSerializer().serializeToString(svg);
                        const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
                        const url = URL.createObjectURL(svgBlob);

                        // Create a simple HTML page for printing
                        const printWindow = window.open('', '_blank');
                        printWindow.document.write(`
                            <!DOCTYPE html>
                            <html>
                            <head><title>Floor Plan - ${projectData?.name || 'Design'}</title>
                            <style>body{margin:0;display:flex;justify-content:center;align-items:center;min-height:100vh;}svg{max-width:100%;}</style>
                            </head>
                            <body>${svgData}
                            <script>setTimeout(()=>{window.print();window.close();},500);</script>
                            </body></html>
                        `);
                        printWindow.document.close();
                        return;
                    }
                }
                window.print();
            } catch (e) {
                window.print();
            }
        }

        async function exportIFC() {
            try {
                const response = await fetch(`${API_URL}/api/export/ifc`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.content_base64) {
                        const binary = atob(data.content_base64);
                        const bytes = new Uint8Array(binary.length);
                        for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
                        downloadBlob(new Blob([bytes], { type: 'application/x-step' }), data.filename || 'design.ifc');
                        alert('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù IFC');
                    } else {
                        alert('IFC export ØºÙŠØ± Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹');
                    }
                } else {
                    alert('IFC export ØºÙŠØ± Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹');
                }
            } catch (e) {
                alert('Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± IFC: ' + e.message);
            }
        }

        async function exportSchedules() {
            try {
                const [rooms, columns] = await Promise.all([
                    fetch(`${API_URL}/api/schedules/rooms`).then(r => r.json()),
                    fetch(`${API_URL}/api/schedules/columns`).then(r => r.json())
                ]);

                // Generate CSV content
                let csv = 'Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØºØ±Ù - Room Schedule\n';
                csv += 'ID,Ø§Ù„Ù†ÙˆØ¹/Type,Ø§Ù„Ø·Ø§Ø¨Ù‚/Floor,Ø§Ù„Ù…Ø³Ø§Ø­Ø©/Area (mÂ²)\n';
                if (rooms.spaces) {
                    rooms.spaces.forEach(s => {
                        csv += `${s.id},${s.type},${s.floor || 'N/A'},${s.area || 'N/A'}\n`;
                    });
                }

                csv += '\nØ¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© - Column Schedule\n';
                csv += 'ID,X (m),Y (m),Ø§Ù„Ø­Ø¬Ù…/Size (mm),Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…/Utilization\n';
                if (columns.columns) {
                    columns.columns.forEach(c => {
                        csv += `${c.id},${c.position[0]},${c.position[1]},${c.size[0]}x${c.size[1]},${(c.utilization*100).toFixed(1)}%\n`;
                    });
                }

                downloadCSV(csv, 'schedules.csv');
                alert('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­');
            } catch (e) {
                alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„: ' + e.message);
            }
        }

        async function exportBOQ() {
            try {
                const [cost, boq] = await Promise.all([
                    fetch(`${API_URL}/api/cost/estimate`).then(r => r.json()),
                    fetch(`${API_URL}/api/export/boq`).then(r => r.json())
                ]);

                // Generate CSV content
                let csv = 'Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙƒÙ…ÙŠØ§Øª - Bill of Quantities (BOQ)\n\n';
                csv += `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ©/Total Cost,${cost.grand_total_SAR?.toLocaleString() || 'N/A'} SAR\n`;
                csv += `ØªÙƒÙ„ÙØ© Ø§Ù„Ù…ØªØ± Ø§Ù„Ù…Ø±Ø¨Ø¹/Cost per mÂ²,${cost.cost_per_m2_SAR?.toLocaleString() || 'N/A'} SAR/mÂ²\n\n`;

                csv += 'Ø§Ù„Ø¨Ù†Ø¯/Item,Ø§Ù„ÙˆØ­Ø¯Ø©/Unit,Ø§Ù„ÙƒÙ…ÙŠØ©/Quantity,Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©/Unit Price,Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ/Total\n';
                if (boq.items) {
                    boq.items.forEach(item => {
                        csv += `${item.description},${item.unit},${item.quantity},${item.unit_price},${item.total}\n`;
                    });
                }

                downloadCSV(csv, 'boq.csv');
                alert('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø¨Ù†Ø¬Ø§Ø­');
            } catch (e) {
                alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ BOQ: ' + e.message);
            }
        }

        async function exportAll() {
            try {
                alert('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª...');
                await Promise.all([
                    exportDWG(),
                    exportSchedules(),
                    exportBOQ()
                ]);
                alert('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª!');
            } catch (e) {
                alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„: ' + e.message);
            }
        }

        function downloadCSV(content, filename) {
            const blob = new Blob(['\ufeff' + content], { type: 'text/csv;charset=utf-8' });
            downloadBlob(blob, filename);
        }

        // Tool Management
        let measurePoints = [];

        function setTool(toolName) {
            currentTool = toolName;

            // Update UI - remove active from all, add to selected
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector(`.tool-btn[data-tool="${toolName}"]`);
            if (activeBtn) activeBtn.classList.add('active');

            // Update cursor based on tool
            const cursors = {
                'select': 'default',
                'pan': 'grab',
                'zoom': 'zoom-in',
                'measure': 'crosshair',
                'info': 'help'
            };

            const svgs = document.querySelectorAll('#svg-2d, #svg-section, #svg-elevation');
            svgs.forEach(svg => {
                if (svg) svg.style.cursor = cursors[toolName] || 'default';
            });

            // Clear measure points when switching tools
            if (toolName !== 'measure') {
                measurePoints = [];
                clearMeasureLines();
            }
        }

        function handleSVGClick(e, svg) {
            if (currentTool === 'measure') {
                handleMeasureClick(e, svg);
            } else if (currentTool === 'info') {
                handleInfoClick(e, svg);
            }
        }

        function handleMeasureClick(e, svg) {
            const rect = svg.getBoundingClientRect();
            const currentViewBox = svg.getAttribute('viewBox').split(' ').map(Number);
            const vbX = currentViewBox[0], vbY = currentViewBox[1];
            const vbW = currentViewBox[2], vbH = currentViewBox[3];

            const x = vbX + (e.clientX - rect.left) / rect.width * vbW;
            const y = vbY + (e.clientY - rect.top) / rect.height * vbH;

            measurePoints.push({ x, y });

            if (measurePoints.length === 1) {
                // Draw start point marker
                addMeasureMarker(svg, x, y);
            } else if (measurePoints.length === 2) {
                const p1 = measurePoints[0];
                const p2 = measurePoints[1];

                // Calculate distance (assuming 12 pixels per meter based on scale in render2DPlan)
                const pixelDist = Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2));
                const meters = (pixelDist / 12).toFixed(2);

                drawMeasureLine(svg, p1, p2, meters);
                measurePoints = [];
            }
        }

        function addMeasureMarker(svg, x, y) {
            const ns = 'http://www.w3.org/2000/svg';
            const circle = document.createElementNS(ns, 'circle');
            circle.setAttribute('cx', x);
            circle.setAttribute('cy', y);
            circle.setAttribute('r', '5');
            circle.setAttribute('fill', '#ef4444');
            circle.setAttribute('class', 'measure-marker');
            svg.appendChild(circle);
        }

        function drawMeasureLine(svg, p1, p2, distance) {
            const ns = 'http://www.w3.org/2000/svg';

            // Draw line
            const line = document.createElementNS(ns, 'line');
            line.setAttribute('x1', p1.x);
            line.setAttribute('y1', p1.y);
            line.setAttribute('x2', p2.x);
            line.setAttribute('y2', p2.y);
            line.setAttribute('stroke', '#ef4444');
            line.setAttribute('stroke-width', '2');
            line.setAttribute('class', 'measure-line');
            svg.appendChild(line);

            // Draw end marker
            const circle = document.createElementNS(ns, 'circle');
            circle.setAttribute('cx', p2.x);
            circle.setAttribute('cy', p2.y);
            circle.setAttribute('r', '5');
            circle.setAttribute('fill', '#ef4444');
            circle.setAttribute('class', 'measure-marker');
            svg.appendChild(circle);

            // Draw distance label
            const midX = (p1.x + p2.x) / 2;
            const midY = (p1.y + p2.y) / 2;

            const bg = document.createElementNS(ns, 'rect');
            bg.setAttribute('x', midX - 25);
            bg.setAttribute('y', midY - 12);
            bg.setAttribute('width', '50');
            bg.setAttribute('height', '16');
            bg.setAttribute('fill', '#ef4444');
            bg.setAttribute('rx', '3');
            bg.setAttribute('class', 'measure-label');
            svg.appendChild(bg);

            const text = document.createElementNS(ns, 'text');
            text.setAttribute('x', midX);
            text.setAttribute('y', midY);
            text.setAttribute('fill', '#fff');
            text.setAttribute('font-size', '10');
            text.setAttribute('text-anchor', 'middle');
            text.setAttribute('dominant-baseline', 'middle');
            text.textContent = `${distance}m`;
            text.setAttribute('class', 'measure-text');
            svg.appendChild(text);
        }

        function clearMeasureLines() {
            document.querySelectorAll('.measure-line, .measure-marker, .measure-label, .measure-text').forEach(el => el.remove());
        }

        function handleInfoClick(e, svg) {
            // Find element under click and show info
            const target = e.target;
            if (target.tagName === 'rect' || target.tagName === 'text') {
                const info = [];
                if (target.getAttribute('fill')) info.push(`Fill: ${target.getAttribute('fill')}`);
                if (target.getAttribute('width')) info.push(`Width: ${target.getAttribute('width')}`);
                if (target.getAttribute('height')) info.push(`Height: ${target.getAttribute('height')}`);
                if (target.textContent && target.tagName === 'text') info.push(`Text: ${target.textContent}`);

                if (info.length > 0) {
                    alert('Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù†ØµØ±:\n' + info.join('\n'));
                }
            }
        }

        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function startNewProject() {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¨Ø¯Ø¡ Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯ØŸ')) location.reload();
        }

        function getDemoData() {
            return {
                architectural: {
                    massing: { width: 31, depth: 40.3, height: 36, floors: 10, floor_height: 3.6, total_area: 12493 },
                    core: { area: 225, side: 15 },
                    spaces: [],
                    efficiency: 72,
                    facade: { wwr_north: 0.4, wwr_south: 0.35 }
                },
                structural: {
                    system: 'braced_frame',
                    material: 'concrete',
                    grid: { bay_x: 7.75, bay_y: 8.06, columns_x: 5, columns_y: 6 },
                    columns: Array.from({length: 30}, (_, i) => ({
                        id: `C${i+1}`,
                        position: [(i % 5) * 7.75, Math.floor(i / 5) * 8.06],
                        size: [400, 400],
                        utilization: 0.72
                    })),
                    slab: { thickness_mm: 250 }
                },
                mep: {
                    hvac: { system_type: 'Chiller_AHU', total_cooling_kW: 850, total_cooling_ton: 242 },
                    electrical: { total_connected_kW: 580 },
                    plumbing: { fixture_count: 120 }
                }
            };
        }
    </script>
</body>
</html>
