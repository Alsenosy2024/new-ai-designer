<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Designer - Ù…ØµÙ…Ù… Ù…Ø¹Ù…Ø§Ø±ÙŠ Ø°ÙƒÙŠ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0f0f1e;
            color: #ffffff;
            overflow: hidden;
        }

        .app-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            grid-template-rows: 60px 1fr;
            height: 100vh;
            gap: 0;
        }

        .header {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-actions {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn-primary {
            background: #ffffff;
            color: #667eea;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(255,255,255,0.3);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.3);
        }

        .sidebar {
            background: #1a1a2e;
            padding: 20px;
            overflow-y: auto;
            border-left: 1px solid #2a2a3e;
        }

        .section {
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 14px;
            color: #8a8a9a;
            text-transform: uppercase;
            margin-bottom: 12px;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            color: #b0b0c0;
            margin-bottom: 6px;
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 10px;
            background: #252538;
            border: 1px solid #3a3a4e;
            border-radius: 6px;
            color: white;
            font-size: 14px;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .stat-card {
            background: #252538;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #3a3a4e;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 11px;
            color: #8a8a9a;
            margin-top: 4px;
        }

        .main-viewport {
            background: #16162a;
            position: relative;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2px;
            padding: 2px;
        }

        .viewer-panel {
            background: #1a1a2e;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }

        .viewer-header {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(26, 26, 46, 0.8);
            backdrop-filter: blur(10px);
            padding: 10px 15px;
            border-radius: 8px;
        }

        .viewer-title {
            font-size: 14px;
            font-weight: bold;
            color: #667eea;
        }

        .viewer-controls {
            display: flex;
            gap: 8px;
        }

        .viewer-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .viewer-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        #canvas2D {
            width: 100%;
            height: 100%;
            display: block;
        }

        #canvas3D {
            width: 100%;
            height: 100%;
            display: block;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(26, 26, 46, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(102, 126, 234, 0.3);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            color: #667eea;
            font-weight: bold;
        }

        .loading-detail {
            margin-top: 10px;
            color: #8a8a9a;
            font-size: 14px;
        }

        .progress-bar {
            width: 300px;
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            margin-top: 15px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
        }

        .viewer-overlay-bottom {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            gap: 15px;
        }

        .metric-pill {
            background: rgba(26, 26, 46, 0.9);
            backdrop-filter: blur(10px);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .metric-pill-icon {
            font-size: 16px;
        }

        .metric-pill-label {
            color: #8a8a9a;
        }

        .metric-pill-value {
            color: #667eea;
            font-weight: bold;
        }

        .zoom-controls {
            position: absolute;
            right: 20px;
            top: 80px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .zoom-btn {
            width: 36px;
            height: 36px;
            background: rgba(26, 26, 46, 0.9);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .zoom-btn:hover {
            background: rgba(102, 126, 234, 0.3);
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a2e;
        }

        ::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                ğŸ—ï¸ AI Designer
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="exportDesign()">ğŸ“¥ ØªØµØ¯ÙŠØ±</button>
                <button class="btn btn-primary" onclick="generateDesign()" id="generateBtn">
                    âœ¨ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªØµÙ…ÙŠÙ…
                </button>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <div class="section">
                <div class="section-title">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</div>
                <div class="form-group">
                    <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</label>
                    <input type="text" class="form-input" id="projectName" value="Ù…Ø¨Ù†Ù‰ Ù…ÙƒØ§ØªØ¨ ØªØ¬Ø±ÙŠØ¨ÙŠ" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹">
                </div>
                <div class="form-group">
                    <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¨Ù†Ù‰</label>
                    <select class="form-select" id="buildingType">
                        <option value="office">Ù…ÙƒØ§ØªØ¨</option>
                        <option value="residential">Ø³ÙƒÙ†ÙŠ</option>
                        <option value="mixed_use">Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ø§Øª</option>
                        <option value="hotel">ÙÙ†Ø¯Ù‚</option>
                        <option value="retail">ØªØ¬Ø§Ø±ÙŠ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
                    <select class="form-select" id="region">
                        <option value="saudi">Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©</option>
                        <option value="uae">Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª</option>
                        <option value="qatar">Ù‚Ø·Ø±</option>
                        <option value="egypt">Ù…ØµØ±</option>
                    </select>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª</div>
                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© (Ù…Â²)</label>
                    <input type="number" class="form-input" id="gfa" value="5000" min="100" max="100000">
                </div>
                <div class="form-group">
                    <label class="form-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø·ÙˆØ§Ø¨Ù‚</label>
                    <input type="number" class="form-input" id="floors" value="5" min="1" max="50">
                </div>
                <div class="form-group">
                    <label class="form-label">Ù†Ø³Ø¨Ø© Ø§Ù„Ù†ÙˆØ§Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©</label>
                    <input type="number" class="form-input" id="coreRatio" value="0.15" min="0.05" max="0.30" step="0.01">
                </div>
            </div>

            <div class="section">
                <div class="section-title">Ø§Ù„Ø£Ù†Ø¸Ù…Ø©</div>
                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¦ÙŠ</label>
                    <select class="form-select" id="structuralSystem">
                        <option value="moment_frame">Ø¥Ø·Ø§Ø± Ø¹Ø²Ù…ÙŠ</option>
                        <option value="braced_frame">Ø¥Ø·Ø§Ø± Ù…Ø¯Ø¹Ù…</option>
                        <option value="shear_wall">Ø¬Ø¯Ø±Ø§Ù† Ù‚Øµ</option>
                        <option value="flat_slab">Ø¨Ù„Ø§Ø·Ø© Ù…Ø³Ø·Ø­Ø©</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙƒÙŠÙŠÙ</label>
                    <select class="form-select" id="hvacSystem">
                        <option value="vav">VAV - Ù…Ø¹Ø¯Ù„ Ù‡ÙˆØ§Ø¡ Ù…ØªØºÙŠØ±</option>
                        <option value="vrf">VRF - ØªØ¯ÙÙ‚ Ù…ØªØºÙŠØ±</option>
                        <option value="chilled_water">Ù…Ø§Ø¡ Ù…Ø¨Ø±Ø¯</option>
                        <option value="split">Ø³Ø¨Ù„ÙŠØª</option>
                    </select>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªØµÙ…ÙŠÙ…</div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="statEfficiency">-</div>
                        <div class="stat-label">Ø§Ù„ÙƒÙØ§Ø¡Ø©</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statCompliance">-</div>
                        <div class="stat-label">Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statSpaces">-</div>
                        <div class="stat-label">Ø§Ù„ÙØ±Ø§ØºØ§Øª</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statEnergy">-</div>
                        <div class="stat-label">Ø§Ù„Ø·Ø§Ù‚Ø©</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Viewport -->
        <div class="main-viewport">
            <!-- 2D Viewer -->
            <div class="viewer-panel">
                <div class="viewer-header">
                    <div class="viewer-title">ğŸ“ Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ù…Ø¹Ù…Ø§Ø±ÙŠ</div>
                    <div class="viewer-controls">
                        <button class="viewer-btn" onclick="zoom2D(1.2)">+</button>
                        <button class="viewer-btn" onclick="zoom2D(0.8)">-</button>
                        <button class="viewer-btn" onclick="reset2D()">â†»</button>
                    </div>
                </div>
                <canvas id="canvas2D"></canvas>
                <div class="viewer-overlay-bottom" id="metrics2D" style="display: none;">
                    <div class="metric-pill">
                        <span class="metric-pill-icon">ğŸ“</span>
                        <span class="metric-pill-label">Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯:</span>
                        <span class="metric-pill-value" id="dimensions">-</span>
                    </div>
                    <div class="metric-pill">
                        <span class="metric-pill-icon">ğŸ“Š</span>
                        <span class="metric-pill-label">Ø§Ù„Ù…Ø³Ø§Ø­Ø©:</span>
                        <span class="metric-pill-value" id="area">-</span>
                    </div>
                </div>
            </div>

            <!-- 3D Viewer -->
            <div class="viewer-panel">
                <div class="viewer-header">
                    <div class="viewer-title">ğŸ¨ Ø§Ù„Ù…Ø¬Ø³Ù… Ø«Ù„Ø§Ø«ÙŠ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯</div>
                    <div class="viewer-controls">
                        <button class="viewer-btn" onclick="toggle3DView()">ğŸ”„ ØªØ¯ÙˆÙŠØ±</button>
                        <button class="viewer-btn" onclick="reset3D()">â†» Ø¥Ø¹Ø§Ø¯Ø©</button>
                    </div>
                </div>
                <div id="canvas3D"></div>
                <div class="viewer-overlay-bottom" id="metrics3D" style="display: none;">
                    <div class="metric-pill">
                        <span class="metric-pill-icon">ğŸ“</span>
                        <span class="metric-pill-label">Ø§Ù„Ø§Ø±ØªÙØ§Ø¹:</span>
                        <span class="metric-pill-value" id="height">-</span>
                    </div>
                    <div class="metric-pill">
                        <span class="metric-pill-icon">ğŸ¢</span>
                        <span class="metric-pill-label">Ø§Ù„Ø·ÙˆØ§Ø¨Ù‚:</span>
                        <span class="metric-pill-value" id="floorsCount">-</span>
                    </div>
                    <div class="metric-pill">
                        <span class="metric-pill-icon">ğŸ“¦</span>
                        <span class="metric-pill-label">Ø§Ù„Ø­Ø¬Ù…:</span>
                        <span class="metric-pill-value" id="volume">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="spinner"></div>
        <div class="loading-text">Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªØµÙ…ÙŠÙ…...</div>
        <div class="loading-detail" id="loadingDetail">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø¯Ø¡...</div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8001';
        let currentDesign = null;
        let canvas2DContext = null;
        let scene3D, camera3D, renderer3D, controls3D;
        let scale2D = 10; // pixels per meter
        let offset2D = { x: 0, y: 0 };

        // Initialize
        window.onload = function() {
            init2DCanvas();
            init3DScene();
        };

        function init2DCanvas() {
            const canvas = document.getElementById('canvas2D');
            canvas2DContext = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;

            // Draw placeholder
            drawPlaceholder2D();
        }

        function init3DScene() {
            const container = document.getElementById('canvas3D');
            const width = container.offsetWidth;
            const height = container.offsetHeight;

            // Scene
            scene3D = new THREE.Scene();
            scene3D.background = new THREE.Color(0x1a1a2e);

            // Camera
            camera3D = new THREE.PerspectiveCamera(60, width / height, 0.1, 10000);
            camera3D.position.set(50, 40, 50);
            camera3D.lookAt(0, 0, 0);

            // Renderer
            renderer3D = new THREE.WebGLRenderer({ antialias: true });
            renderer3D.setSize(width, height);
            renderer3D.shadowMap.enabled = true;
            container.appendChild(renderer3D.domElement);

            // Controls
            controls3D = new THREE.OrbitControls(camera3D, renderer3D.domElement);
            controls3D.enableDamping = true;
            controls3D.dampingFactor = 0.05;

            // Lights
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene3D.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(50, 100, 50);
            directionalLight.castShadow = true;
            scene3D.add(directionalLight);

            // Ground
            const groundGeometry = new THREE.PlaneGeometry(200, 200);
            const groundMaterial = new THREE.MeshStandardMaterial({
                color: 0x252538,
                roughness: 0.8
            });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = -0.1;
            ground.receiveShadow = true;
            scene3D.add(ground);

            // Grid
            const grid = new THREE.GridHelper(200, 40, 0x667eea, 0x3a3a4e);
            scene3D.add(grid);

            // Draw placeholder
            drawPlaceholder3D();

            // Animation loop
            animate3D();
        }

        function animate3D() {
            requestAnimationFrame(animate3D);
            controls3D.update();
            renderer3D.render(scene3D, camera3D);
        }

        function drawPlaceholder2D() {
            const ctx = canvas2DContext;
            const canvas = ctx.canvas;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = '#252538';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = '#667eea';
            ctx.font = '20px "Segoe UI"';
            ctx.textAlign = 'center';
            ctx.fillText('Ø§Ø¨Ø¯Ø£ Ø¨ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªØµÙ…ÙŠÙ…', canvas.width / 2, canvas.height / 2);
        }

        function drawPlaceholder3D() {
            // Placeholder cube
            const geometry = new THREE.BoxGeometry(20, 15, 20);
            const material = new THREE.MeshStandardMaterial({
                color: 0x667eea,
                transparent: true,
                opacity: 0.3
            });
            const cube = new THREE.Mesh(geometry, material);
            cube.position.y = 7.5;
            cube.castShadow = true;
            scene3D.add(cube);
        }

        async function generateDesign() {
            const btn = document.getElementById('generateBtn');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingDetail = document.getElementById('loadingDetail');
            const progressFill = document.getElementById('progressFill');

            btn.disabled = true;
            btn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆÙ„ÙŠØ¯...';
            loadingOverlay.style.display = 'flex';

            try {
                // Collect input data
                const projectData = {
                    name: document.getElementById('projectName').value,
                    type: document.getElementById('buildingType').value,
                    region: document.getElementById('region').value,
                    gfa: document.getElementById('gfa').value,
                    floors: document.getElementById('floors').value,
                    core_ratio: document.getElementById('coreRatio').value,
                    structural_system: document.getElementById('structuralSystem').value,
                    mep_strategy: document.getElementById('hvacSystem').value,
                    budget: 'standard'
                };

                // Step 1: Create project
                loadingDetail.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹...';
                progressFill.style.width = '20%';

                const projectResponse = await fetch(`${API_BASE}/api/state`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ project: projectData })
                });

                const projectResult = await projectResponse.json();
                const projectId = projectResult.project.id;

                // Step 2: Start design run
                loadingDetail.textContent = 'Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø°ÙƒÙŠ...';
                progressFill.style.width = '40%';

                await fetch(`${API_BASE}/api/runs/start?project_id=${projectId}&stage=full`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                // Step 3: Poll for completion
                let completed = false;
                let attempts = 0;
                const maxAttempts = 120;

                while (!completed && attempts < maxAttempts) {
                    await new Promise(resolve => setTimeout(resolve, 2000));

                    const statusResponse = await fetch(`${API_BASE}/api/state?project_id=${projectId}`);
                    const statusData = await statusResponse.json();

                    const progress = 40 + (attempts / maxAttempts * 50);
                    progressFill.style.width = progress + '%';
                    loadingDetail.textContent = `Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªØµÙ…ÙŠÙ…... (${Math.round(progress)}%)`;

                    if (statusData.run?.status === 'Complete') {
                        completed = true;
                        currentDesign = statusData;
                        progressFill.style.width = '100%';
                        loadingDetail.textContent = 'Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªØµÙ…ÙŠÙ…!';

                        // Render design
                        setTimeout(() => {
                            loadingOverlay.style.display = 'none';
                            renderDesign(statusData);
                        }, 500);
                    }

                    attempts++;
                }

                if (!completed) {
                    throw new Error('Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ù‡Ù„Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©');
                }

            } catch (error) {
                console.error('Error:', error);
                loadingOverlay.style.display = 'none';
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'âœ¨ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªØµÙ…ÙŠÙ…';
            }
        }

        function renderDesign(data) {
            console.log('Rendering design:', data);

            // Update stats
            document.getElementById('statEfficiency').textContent = '82%';
            document.getElementById('statCompliance').textContent = data.outputs?.compliance || '-';
            document.getElementById('statSpaces').textContent = '12';
            document.getElementById('statEnergy').textContent = data.outputs?.energy || '-';

            // Render 2D
            render2DPlan(data);

            // Render 3D
            render3DModel(data);

            // Show metrics
            document.getElementById('metrics2D').style.display = 'flex';
            document.getElementById('metrics3D').style.display = 'flex';
        }

        function render2DPlan(data) {
            const ctx = canvas2DContext;
            const canvas = ctx.canvas;

            // Sample data (replace with actual floor plan data)
            const width = 40;
            const depth = 30;
            const scale = Math.min(canvas.width / width, canvas.height / depth) * 0.8;

            const offsetX = (canvas.width - width * scale) / 2;
            const offsetY = (canvas.height - depth * scale) / 2;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw building outline
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 3;
            ctx.strokeRect(offsetX, offsetY, width * scale, depth * scale);

            // Draw grid
            ctx.strokeStyle = '#3a3a4e';
            ctx.lineWidth = 1;
            for (let i = 0; i <= width; i += 8) {
                ctx.beginPath();
                ctx.moveTo(offsetX + i * scale, offsetY);
                ctx.lineTo(offsetX + i * scale, offsetY + depth * scale);
                ctx.stroke();
            }
            for (let i = 0; i <= depth; i += 8) {
                ctx.beginPath();
                ctx.moveTo(offsetX, offsetY + i * scale);
                ctx.lineTo(offsetX + width * scale, offsetY + i * scale);
                ctx.stroke();
            }

            // Draw spaces
            ctx.fillStyle = 'rgba(102, 126, 234, 0.2)';
            ctx.fillRect(offsetX + 5 * scale, offsetY + 5 * scale, 15 * scale, 10 * scale);

            ctx.fillStyle = '#ffffff';
            ctx.font = '14px "Segoe UI"';
            ctx.textAlign = 'center';
            ctx.fillText('Ù…ÙƒØªØ¨ Ù…ÙØªÙˆØ­', offsetX + 12.5 * scale, offsetY + 10 * scale);

            // Update metrics
            document.getElementById('dimensions').textContent = `${width}Ã—${depth} Ù…`;
            document.getElementById('area').textContent = `${width * depth} Ù…Â²`;
        }

        function render3DModel(data) {
            // Clear existing objects
            while(scene3D.children.length > 5) {
                scene3D.remove(scene3D.children[5]);
            }

            // Sample building (replace with actual massing data)
            const width = 40;
            const depth = 30;
            const floors = parseInt(document.getElementById('floors').value);
            const floorHeight = 3.6;
            const totalHeight = floors * floorHeight;

            // Building mass
            const buildingGeometry = new THREE.BoxGeometry(width, totalHeight, depth);
            const buildingMaterial = new THREE.MeshStandardMaterial({
                color: 0x667eea,
                transparent: true,
                opacity: 0.8,
                roughness: 0.3,
                metalness: 0.5
            });
            const building = new THREE.Mesh(buildingGeometry, buildingMaterial);
            building.position.y = totalHeight / 2;
            building.castShadow = true;
            building.receiveShadow = true;
            scene3D.add(building);

            // Floor slabs
            for (let i = 0; i <= floors; i++) {
                const slabGeometry = new THREE.BoxGeometry(width, 0.3, depth);
                const slabMaterial = new THREE.MeshStandardMaterial({
                    color: 0x3a3a4e,
                    metalness: 0.8
                });
                const slab = new THREE.Mesh(slabGeometry, slabMaterial);
                slab.position.y = i * floorHeight;
                scene3D.add(slab);
            }

            // Update metrics
            document.getElementById('height').textContent = totalHeight.toFixed(1) + ' Ù…';
            document.getElementById('floorsCount').textContent = floors;
            document.getElementById('volume').textContent = (width * depth * totalHeight).toFixed(0) + ' Ù…Â³';

            // Adjust camera
            const maxDim = Math.max(width, depth, totalHeight);
            camera3D.position.set(maxDim * 1.5, maxDim, maxDim * 1.5);
            camera3D.lookAt(0, totalHeight / 2, 0);
        }

        function zoom2D(factor) {
            scale2D *= factor;
            if (currentDesign) render2DPlan(currentDesign);
        }

        function reset2D() {
            scale2D = 10;
            offset2D = { x: 0, y: 0 };
            if (currentDesign) render2DPlan(currentDesign);
        }

        function toggle3DView() {
            controls3D.autoRotate = !controls3D.autoRotate;
        }

        function reset3D() {
            const floors = parseInt(document.getElementById('floors').value) || 5;
            const totalHeight = floors * 3.6;
            camera3D.position.set(50, 40, 50);
            camera3D.lookAt(0, totalHeight / 2, 0);
            controls3D.autoRotate = false;
        }

        function exportDesign() {
            if (!currentDesign) {
                alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØµÙ…ÙŠÙ… Ù„ØªØµØ¯ÙŠØ±Ù‡');
                return;
            }

            // Export design data
            const exportData = {
                project: currentDesign.project,
                outputs: currentDesign.outputs,
                timestamp: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `design_${currentDesign.project.name}_${Date.now()}.json`;
            a.click();
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            const canvas2D = document.getElementById('canvas2D');
            canvas2D.width = canvas2D.offsetWidth;
            canvas2D.height = canvas2D.offsetHeight;
            if (currentDesign) render2DPlan(currentDesign);

            const container = document.getElementById('canvas3D');
            const width = container.offsetWidth;
            const height = container.offsetHeight;
            camera3D.aspect = width / height;
            camera3D.updateProjectionMatrix();
            renderer3D.setSize(width, height);
        });
    </script>
</body>
</html>
